#C:\Users\alexr\Desktop\dev\super_bot\smart_agent\executor\apps\description_generate.py
from __future__ import annotations

import os
import logging
from typing import Any, Dict, List, Optional, Tuple
from flask import jsonify, Request
from executor.config import OPENAI_API_KEY
import threading
import requests
import json
import re
from urllib.parse import urlparse
import bot.utils.logging_config as logging_config

log = logging_config.logger


try:
    from openai import OpenAI
except Exception:
    OpenAI = None

_FALLBACK_MODELS: List[str] = ["gpt-5", "gpt-4o", "gpt-4.1", "gpt-4o-mini", "gpt-4.1-mini"]

_client_default: Any = None


# =========================
# OpenAI helpers (client + send)
# =========================
def _extract_text(resp: Any) -> str:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ—Å—Ç–∞—ë–º —Ç–µ–∫—Å—Ç –∏–∑ Chat Completions –æ—Ç–≤–µ—Ç–∞.
    """
    try:
        return (resp.choices[0].message.content or "").strip()
    except Exception:
        return ""


def _client_or_init(api_key: Optional[str]) -> Any:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç OpenAI-–∫–ª–∏–µ–Ω—Ç:
      - –µ—Å–ª–∏ –∫–ª—é—á per-request —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏ –∫–µ—à–∏—Ä—É–µ–º –æ–±—â–∏–π –∫–ª–∏–µ–Ω—Ç;
      - –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –∏–Ω–æ–π –∫–ª—é—á ‚Äî —Å–æ–∑–¥–∞—ë–º ephemeral –∫–ª–∏–µ–Ω—Ç (–±–µ–∑ –∫–µ—à–∞).
    """
    if OpenAI is None:
        raise RuntimeError("openai package is not installed")

    default_key = _default_api_key()
    req_key = (api_key or default_key or "").strip()
    if not req_key:
        raise RuntimeError("OPENAI_API_KEY is missing (config/env or request header/body)")

    global _client_default
    if req_key == default_key:
        if _client_default is None:
            _client_default = OpenAI(api_key=req_key)
        return _client_default
    # per-request ¬´—á—É–∂–æ–π¬ª –∫–ª—é—á ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
    return OpenAI(api_key=req_key)


def _send_with_fallback(payload: Dict[str, Any],
                        default_model: str,
                        allow_fallback: bool,
                        api_key: Optional[str]) -> Tuple[str, str]:
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ Chat Completions —Å —Ü–µ–ø–æ—á–∫–æ–π fallback-–º–æ–¥–µ–ª–µ–π.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (text, model_used).
    """
    client = _client_or_init(api_key)
    first_model = payload.get("model") or default_model
    chain = [first_model] + ([m for m in _FALLBACK_MODELS if m != first_model] if allow_fallback else [])
    last_err: Optional[Exception] = None

    for i, model_name in enumerate(chain, start=1):
        try:
            req = dict(payload)
            req["model"] = model_name
            
            # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ OpenAI
            if "messages" in req:
                log.info("OpenAI prompt: %s", json.dumps(req["messages"], ensure_ascii=False, indent=2))
            resp = client.chat.completions.create(**req)
            text = _extract_text(resp)
            if text:
                if i > 1:
                    log.warning("Fallback model used: %s (requested %s)", model_name, first_model)
                return text, model_name
            last_err = RuntimeError("Empty completion text")
        except Exception as e:
            last_err = e
            log.warning("OpenAI call failed on model %s: %s", model_name, e)

    log.error("All OpenAI fallbacks failed. Last error: %s", last_err)
    raise last_err or RuntimeError("OpenAI request failed")


# =========================
# –ö–æ–Ω—Ñ–∏–≥ / –õ–æ–≥–≥–µ—Ä
# =========================
HTTP_DEBUG = os.getenv("HTTP_DEBUG", "0") == "1"
OPENAI_FALLBACK = os.getenv("OPENAI_FALLBACK", "1") == "1"

# –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å
DESCRIPTION_MODEL = os.getenv("DESCRIPTION_MODEL", "gpt-5")

# ------------------ –ö–∞—Ä—Ç—ã –ª–µ–π–±–ª–æ–≤ –¥–ª—è select-–ø–æ–ª–µ–π ------------------
# NB: —ç—Ç–æ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ ¬´—á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã—Ö¬ª –ª–µ–π–±–ª–æ–≤ –∏ –¥–ª—è UI, –∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–º–ø—Ç–∞
DESCRIPTION_TYPES = {
    "flat": "–ö–≤–∞—Ä—Ç–∏—Ä–∞",
    "house": "–î–æ–º",
    "office": "–û—Ñ–∏—Å",
    "comm": "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å",
    "commercial": "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å",
    "land": "–ó–µ–º–µ–ª—å–Ω—ã–π —É—á–∞—Å—Ç–æ–∫",
    "country": "–ó–∞–≥–æ—Ä–æ–¥–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å",
    "zagorod": "–ó–∞–≥–æ—Ä–æ–¥–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å",
}

DESCRIPTION_CLASSES = {
    "econom": "–≠–∫–æ–Ω–æ–º",
    "comfort": "–ö–æ–º—Ñ–æ—Ä—Ç",
    "business": "–ë–∏–∑–Ω–µ—Å",
    "premium": "–ü—Ä–µ–º–∏—É–º",
}

DESCRIPTION_COMPLEX = {
    "yes": "–î–∞ (–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–ñ–ö)",
    "no": "–ù–µ—Ç",
}

DESCRIPTION_AREA = {
    "city": "–í —á–µ—Ä—Ç–µ –≥–æ—Ä–æ–¥–∞",
    "out": "–ó–∞ –≥–æ—Ä–æ–¥–æ–º",
}


# ------------------ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ USER-TEMPLATE –ø–æ —Ç–∏–ø–∞–º ------------------
# –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Äî –ü–†–û–î–ê–ñ–ê
DESCRIPTION_USER_TEMPLATE_FLAT_SALE_RU = """
üéØ –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å:

–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏ –ª–æ–≥–∏–∫–µ –≤–µ–¥—ë—Ç –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫ –¥–æ–≤–µ—Ä–∏—é –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É ‚Äú—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å‚Äù,
 –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.

–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è:
 ‚Ä¢ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —á—Ç–æ —Ä—è–¥–æ–º, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø—Ä–æ–≥—É–ª–æ—á–Ω—ã–µ –∑–æ–Ω—ã.
 ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ‚Äî —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–∫–æ–º–Ω–∞—Ç—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏), –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –≤—ã–≥–æ–¥—ã –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
 ‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ —Å–¥–µ–ª–∫—É, –∏–ø–æ—Ç–µ–∫–∞.
 ‚Ä¢ –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä, –∑–≤–æ–Ω–æ–∫.
 2. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ ‚Üí –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ ‚Üí –≤—ã–≥–æ–¥–∞ ‚Äî –≤—Å–µ–≥–¥–∞ —Å–≤—è–∑—ã–≤–∞–π —Ñ–∞–∫—Ç—ã –æ–± –æ–±—ä–µ–∫—Ç–µ —Å —Ç–µ–º, —á–µ–º —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
 3. –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–∞–Ω—Ç–∞–∑–∏–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–π.
 4. –ò–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ, —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Å–ª–æ–≤–∞ —Ä–∞–¥–∏ —Å–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—É—é—Ç–Ω–∞—è¬ª, ¬´—Å–≤–µ—Ç–ª–∞—è¬ª, ¬´–º–µ—Ç—Ä–∞–∂¬ª –∏ —Ç.–¥.), –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—á–Ω—ã–º, –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
 5. –¢–æ–Ω —Ç–µ–∫—Å—Ç–∞: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∂–∏–≤–æ–π, —Å–ª–µ–≥–∫–∞ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –Ω–æ –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π –≤—ã—á—É—Ä–Ω–æ—Å—Ç–∏.
 6. –°–æ–∑–¥–∞–≤–∞–π –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ç–µ–∫—Å—Ç–∞:
 ‚Ä¢ –ü–æ–ª–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–ª—è –¶–ò–ê–ù, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —á–∏—Å—Ç–æ—Ç—É –∏ —É–¥–æ–±—Å—Ç–≤–æ)
 ‚Ä¢ –ö–æ—Ä–æ—Ç–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–ª—è –ê–≤–∏—Ç–æ, —Ü–µ–ø–ª—è—é—â–∏–π, –¥–æ ~600 —Å–∏–º–≤–æ–ª–æ–≤, —Å –ø–µ—Ä–≤–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞—Ü–µ–ø–ª—è—é—â–∏–π –≤–Ω–∏–º–∞–Ω–∏–µ)
 7. –ü—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –ê–≤–∏—Ç–æ –¥–ª—è –ê/–ë-—Ç–µ—Å—Ç–∞.

–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
 ‚Ä¢ –õ–æ–∫–∞—Ü–∏—è: [–≥–æ—Ä–æ–¥ –∏ –∞–¥—Ä–µ—Å]
 ‚Ä¢ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: [—à–∫–æ–ª—ã, –º–∞–≥–∞–∑–∏–Ω—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è –∏ —Ç.–¥.]
 ‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–º–µ—â–µ–Ω–∏—è]
 ‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã: [—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∏–ø–æ—Ç–µ–∫–∞, –±—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –Ω–∞ —Å–¥–µ–ª–∫—É]

–ó–∞–¥–∞—á–∞:
–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–∞–≤—å:
 1. –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –¶–ò–ê–ù
 2. –ö–æ—Ä–æ—Ç–∫–∏–π, —Ü–µ–ø–ª—è—é—â–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –ê–≤–∏—Ç–æ
 3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –ê–≤–∏—Ç–æ –¥–ª—è –ê/–ë-—Ç–µ—Å—Ç–∞
‚∏ª

üí° –ì–ª–∞–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏:

–ü–æ—Å—Ç—Ä–æ–π –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—á–Ω–æ: –ª–æ–∫–∞—Ü–∏—è ‚Üí –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Üí –æ–±—ä–µ–∫—Ç ‚Üí —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —á–∏—Å—Ç–æ—Ç–∞ ‚Üí –º—è–≥–∫–æ–µ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ –≤ –ø–æ–∫—É–ø–∫—É.
–ü–∏—à–∏ —á–µ—Å—Ç–Ω–æ, —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ –∏ —Å –≤–Ω–∏–º–∞–Ω–∏–µ–º –∫ –¥–µ—Ç–∞–ª—è–º. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å, –∫–∞–∫ –±—É–¥—Ç–æ –µ–≥–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø—ã—Ç–Ω—ã–π —Ä–∏—ç–ª—Ç–æ—Ä —Å–≤–æ–µ–º—É –∫–ª–∏–µ–Ω—Ç—É.

‚öôÔ∏è –ü—Ä–∞–≤–∏–ª–∞ —Å—Ç–∏–ª—è:
 ‚Ä¢ –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥–∞.
 ‚Ä¢ –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å—Å—è –∫–∞–∫ —Ä–∞—Å—Å–∫–∞–∑ —Ä–∏—ç–ª—Ç–æ—Ä–∞, –∞ –Ω–µ —Ä–µ–∫–ª–∞–º–∞.
 ‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—ã–µ —ç–ø–∏—Ç–µ—Ç—ã –∏ –±–∞–Ω–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã.
 ‚Ä¢ –ö–∞–∂–¥—ã–π –±–ª–æ–∫ ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–Ω—ã–π –∞–±–∑–∞—Ü, –º–µ–∂–¥—É –Ω–∏–º–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑–∫–∞.

‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: –æ–±—â–∞—è {total_area} –º¬≤, –∫—É—Ö–Ω—è {kitchen_area} –º¬≤, –∫–æ–º–Ω–∞—Ç—ã {rooms}, —ç—Ç–∞–∂ {floor_number}/{building_floors}, –ø–æ—Ç–æ–ª–∫–∏ {ceiling_height_m} –º, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ {layout}, –±–∞–ª–∫–æ–Ω/–ª–æ–¥–∂–∏—è {balcony}.

‚Äî –î–æ–º/–ñ–ö/–º–∞—Ç–µ—Ä–∏–∞–ª: {in_complex_label}, —Ç–∏–ø: {type_label} {apt_class_label}, –º–∞—Ç–µ—Ä–∏–∞–ª {house_type}, –ª–∏—Ñ—Ç—ã {lift}, –æ–∫–Ω–∞ {windows}, —Å–∞–Ω—É–∑–µ–ª {bathroom_type}, –ø–∞—Ä–∫–æ–≤–∫–∞ {parking}, –æ—Ç–¥–µ–ª–∫–∞ {renovation}.

‚Äî –õ–æ–∫–∞—Ü–∏—è: {location}; (—Ç–µ–∫—Å—Ç) –∞–¥—Ä–µ—Å/–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã: {flat_location_text}; (—Ç–µ–∫—Å—Ç) –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: {flat_infrastructure_text}; –æ–±—â–∞—è –∑–æ–Ω–∞: {area_label}.
4) –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏: —Å–¥–µ–ª–∫–∞ {deal_label}, —Å–ø–æ—Å–æ–± –ø—Ä–æ–¥–∞–∂–∏ {sale_method}, —Å—Ä–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏/—Å–¥–∞—á–∏ {completion_term}, –∏–ø–æ—Ç–µ–∫–∞ {mortgage_ok}, —é—Ä.–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: {flat_legal_text}.
5) –°–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –Ω—é–∞–Ω—Å–∞–º–∏: {comment}
"""

# –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Äî –ê–†–ï–ù–î–ê
DESCRIPTION_USER_TEMPLATE_FLAT_RENT_RU = """
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≥–æ—Ç–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–∫–≤–∞—Ä—Ç–∏—Ä–∞, –ê–†–ï–ù–î–ê) –ø–æ –¥–∞–Ω–Ω—ã–º –Ω–∏–∂–µ, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
–ï—Å–ª–∏ –∫–∞–∫–æ–µ-–ª–∏–±–æ –ø–æ–ª–µ —Ä–∞–≤–Ω–æ ¬´‚Äî¬ª –∏–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º—ã—Å–ª—å/—Å—Ç—Ä–æ–∫—É/–±–ª–æ–∫.

–ö–æ–º–ø–æ–∑–∏—Ü–∏—è:
1) –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–¥–æ ~70 —Å–∏–º–≤–æ–ª–æ–≤) ‚Äî –ø–æ–ª—å–∑–∞/—Å—Ü–µ–Ω–∞—Ä–∏–π –∂–∏–∑–Ω–∏.
2) –õ–∏–¥-–∞–±–∑–∞—Ü ‚Äî –∫–æ–º—Ñ–æ—Ä—Ç, —Ç–∏—à–∏–Ω–∞, –±—ã—Ç, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç/–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞.
3) 4‚Äì6 –≤—ã–≥–æ–¥-–º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî ¬´—Ñ–∞–∫—Ç ‚Üí –ø–æ–ª—å–∑–∞ –∂–∏–ª—å—Ü—É¬ª.
4) –ú–∏–∫—Ä–æ-–±–ª–æ–∫–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–∞–∫—Ç–æ–≤):
‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: {total_area} –º¬≤, –∫—É—Ö–Ω—è {kitchen_area} –º¬≤, –∫–æ–º–Ω–∞—Ç—ã {rooms}, —ç—Ç–∞–∂ {floor_number}/{building_floors}, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ {amenities}.
‚Äî –î–æ–º/–ñ–ö: {in_complex_label}, –∫–ª–∞—Å—Å/—Ç–∏–ø: {type_label} {apt_class_label}.
‚Äî –õ–æ–∫–∞—Ü–∏—è: {location} (–∏ ¬´{area_label}¬ª, –µ—Å–ª–∏ –≤–∞–∂–Ω–æ).
‚Äî –ê–¥—Ä–µ—Å/–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã (—Ç–µ–∫—Å—Ç): {flat_location_text}
‚Äî –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—è–¥–æ–º (—Ç–µ–∫—Å—Ç): {flat_infrastructure_text}
5) –£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã
‚Äî –ö–æ—Ä–æ—Ç–∫–æ: —Å—Ä–æ–∫/–∑–∞–ª–æ–≥/–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ/–ø—Ä–∞–≤–∏–ª–∞. –ù–µ —É–ø–æ–º–∏–Ω–∞–π –∏–ø–æ—Ç–µ–∫—É.
6) CTA –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä/—Å–æ–∑–≤–æ–Ω.

–î–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–æ —Å–º—ã—Å–ª—É, –±–µ–∑ –≤—ã–≤–æ–¥–∞ ¬´‚Äî¬ª):
‚Äî –¢–∏–ø: {type_label}
‚Äî –ö–ª–∞—Å—Å: {apt_class_label}
‚Äî –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–ñ–ö: {in_complex_label}
‚Äî –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–æ–±—â–µ–µ): {area_label}
‚Äî –õ–æ–∫–∞—Ü–∏—è (—Ä–∞–π–æ–Ω/–º–µ—Ç—Ä–æ/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç): {location}
‚Äî –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: {total_area} –º¬≤
‚Äî –ö—É—Ö–Ω—è: {kitchen_area} –º¬≤
‚Äî –≠—Ç–∞–∂ / –≠—Ç–∞–∂–Ω–æ—Å—Ç—å: {floor_number} / {building_floors}
‚Äî –ö–æ–º–Ω–∞—Ç: {rooms}
‚Äî –ì–æ–¥ / –°–æ—Å—Ç–æ—è–Ω–∏–µ: {year_state}
‚Äî –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: {utilities}
‚Äî –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏/—É–¥–æ–±—Å—Ç–≤–∞: {amenities}
‚Äî –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}
‚Äî (–¢–µ–∫—Å—Ç) –õ–æ–∫–∞—Ü–∏—è: {flat_location_text}
‚Äî (–¢–µ–∫—Å—Ç) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: {flat_infrastructure_text}
"""

# –ó–∞–≥–æ—Ä–æ–¥–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
DESCRIPTION_USER_TEMPLATE_COUNTRY_RU = """
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≥–æ—Ç–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–∑–∞–≥–æ—Ä–æ–¥–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å) –ø–æ –¥–∞–Ω–Ω—ã–º –Ω–∏–∂–µ, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
–ï—Å–ª–∏ –∫–∞–∫–æ–µ-–ª–∏–±–æ –ø–æ–ª–µ —Ä–∞–≤–Ω–æ ¬´‚Äî¬ª –∏–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º—ã—Å–ª—å/—Å—Ç—Ä–æ–∫—É/–±–ª–æ–∫.

–ö–æ–º–ø–æ–∑–∏—Ü–∏—è:
1) –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏/–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–∫–∞.
2) –õ–∏–¥ ‚Äî –≤–æ–∑–¥—É—Ö/—Ç–∏—à–∏–Ω–∞/–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞/–ø–æ–¥—ä–µ–∑–¥–Ω–æ—Å—Ç—å (–ø–æ —Ñ–∞–∫—Ç–∞–º).
3) 4‚Äì6 –≤—ã–≥–æ–¥-–º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –¥–æ–º, —É—á–∞—Å—Ç–æ–∫, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –æ–∫—Ä—É–∂–µ–Ω–∏–µ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.
4) –ú–∏–∫—Ä–æ-–±–ª–æ–∫–∏:
‚Äî –î–æ–º/–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: –ø–ª–æ—â–∞–¥—å {total_area} –º¬≤, –∫–æ–º–Ω–∞—Ç—ã {rooms}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ {year_state}, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ {amenities}.
‚Äî –£—á–∞—Å—Ç–æ–∫/–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: {utilities}.
‚Äî –õ–æ–∫–∞—Ü–∏—è/–î–æ—Å—Ç—É–ø: {location} ({area_label}, –µ—Å–ª–∏ –≤–∞–∂–Ω–æ).
5) –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏ ‚Äî –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É.
6) CTA ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä/—Å–æ–∑–≤–æ–Ω.

–î–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–æ —Å–º—ã—Å–ª—É, –±–µ–∑ –≤—ã–≤–æ–¥–∞ ¬´‚Äî¬ª):
‚Äî –¢–∏–ø: {type_label}
‚Äî –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–æ–±—â–µ–µ): {area_label}
‚Äî –õ–æ–∫–∞—Ü–∏—è (—Ä–∞–π–æ–Ω/—Ç—Ä–∞—Å—Å–∞/–æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã): {location}
‚Äî –ü–ª–æ—â–∞–¥—å –¥–æ–º–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å): {total_area} –º¬≤
‚Äî –ö–æ–º–Ω–∞—Ç: {rooms}
‚Äî –°–æ—Å—Ç–æ—è–Ω–∏–µ/–≥–æ–¥: {year_state}
‚Äî –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: {utilities}
‚Äî –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: {amenities}
‚Äî –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}
"""

# –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
DESCRIPTION_USER_TEMPLATE_COMMERCIAL_RU = """
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≥–æ—Ç–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å) –ø–æ –¥–∞–Ω–Ω—ã–º –Ω–∏–∂–µ, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
–ï—Å–ª–∏ –∫–∞–∫–æ–µ-–ª–∏–±–æ –ø–æ–ª–µ —Ä–∞–≤–Ω–æ ¬´‚Äî¬ª –∏–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º—ã—Å–ª—å/—Å—Ç—Ä–æ–∫—É/–±–ª–æ–∫.

–ö–æ–º–ø–æ–∑–∏—Ü–∏—è:
1) –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –ø–æ–ª—å–∑–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ (—Ç—Ä–∞—Ñ–∏–∫/–≤–∏—Ç—Ä–∏–Ω—ã/–¥–æ—Å—Ç—É–ø).
2) –õ–∏–¥ ‚Äî —Ñ–æ—Ä–º–∞—Ç –ø–æ–º–µ—â–µ–Ω–∏—è –∏ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≥–æ–¥—ã –¥–ª—è –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞/–ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
3) 4‚Äì6 –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –ª–æ–∫–∞—Ü–∏—è/–ø–æ—Ç–æ–∫, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –≤—ã—Å–æ—Ç–∞, –≤—Ö–æ–¥–Ω—ã–µ –≥—Ä—É–ø–ø—ã, –ø–∞—Ä–∫–æ–≤–∫–∞, –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–ø–æ —Ñ–∞–∫—Ç–∞–º).
4) –ú–∏–∫—Ä–æ-–±–ª–æ–∫–∏:
‚Äî –ü–æ–º–µ—â–µ–Ω–∏–µ: –æ—Ä–∏–µ–Ω—Ç–∏—Ä –Ω–∞ –ø–ª–æ—â–∞–¥—å {total_area} –º¬≤, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ {amenities}.
‚Äî –ó–¥–∞–Ω–∏–µ/–ë–¶: {in_complex_label} / {type_label}.
‚Äî –õ–æ–∫–∞—Ü–∏—è/–î–æ—Å—Ç—É–ø: {location} ({area_label}, –µ—Å–ª–∏ –≤–∞–∂–Ω–æ), –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ {utilities}.
5) –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏ (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞) ‚Äî –ù–î–°/–∫–∞–Ω–∏–∫—É–ª—ã/—Ñ–æ—Ä–º–∞—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–∫—Ç—ã –µ—Å—Ç—å.
6) CTA ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä/–±—Ä–∏—Ñ/–∫–æ–Ω—Ç–∞–∫—Ç.

–î–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–æ —Å–º—ã—Å–ª—É, –±–µ–∑ –≤—ã–≤–æ–¥–∞ ¬´‚Äî¬ª):
‚Äî –¢–∏–ø: {type_label}
‚Äî –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–æ–±—â–µ–µ): {area_label}
‚Äî –õ–æ–∫–∞—Ü–∏—è: {location}
‚Äî –ü–ª–æ—â–∞–¥—å (–µ—Å–ª–∏ –µ—Å—Ç—å): {total_area} –º¬≤
‚Äî –°–æ—Å—Ç–æ—è–Ω–∏–µ/–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: {year_state}; {amenities}
‚Äî –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: {utilities}
‚Äî –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}
"""

# Fallback
DESCRIPTION_USER_TEMPLATE_RU = """
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≥–æ—Ç–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ –¥–∞–Ω–Ω—ã–º –Ω–∏–∂–µ, —Å–æ–±–ª—é–¥–∞—è –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞.
–ï—Å–ª–∏ –∫–∞–∫–æ–µ-–ª–∏–±–æ –ø–æ–ª–µ —Ä–∞–≤–Ω–æ ¬´‚Äî¬ª –∏–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º—ã—Å–ª—å/—Å—Ç—Ä–æ–∫—É/–±–ª–æ–∫.

–¢—Ä–µ–±—É–µ–º–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è (–Ω–µ –∫–∞–∫ —Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–Ω–∫–µ—Ç–∞, –∞ –∫–∞–∫ –ø—Ä–æ–¥–∞—é—â–∏–π —Ç–µ–∫—Å—Ç):

1) –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–¥–æ ~70 —Å–∏–º–≤–æ–ª–æ–≤)
‚Äî 1 –∫–ª—é—á–µ–≤–∞—è –≤—ã–≥–æ–¥–∞, –±–µ–∑ –∫–ª–∏—à–µ –∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫.

2) –õ–∏–¥-–∞–±–∑–∞—Ü (1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
‚Äî –°–±–æ—Ä–∫–∞ –≥–ª–∞–≤–Ω—ã—Ö —Å–º—ã—Å–ª–æ–≤: –º–µ—Ç—Ä–∞–∂/–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞/—ç—Ç–∞–∂–Ω–æ—Å—Ç—å ‚Üí –æ—â—É—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞/—Å–≤–µ—Ç–∞ ‚Üí –¥–ª—è –∫–æ–≥–æ —ç—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ.

3) 4‚Äì6 –≤—ã–≥–æ–¥—ã-–º–∞—Ä–∫–µ—Ä–æ–≤
‚Äî –ö–∞–∂–¥—ã–π –º–∞—Ä–∫–µ—Ä = ¬´—Ñ–∞–∫—Ç ‚Üí –∑–∞—á–µ–º —ç—Ç–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é¬ª. –°—Ç–∞—Ä–∞–π—Å—è –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.
‚Äî –î–∏–∞–ø–∞–∑–æ–Ω—ã –∏ –∫–æ–¥—ã –ø—Ä–µ–≤—Ä–∞—â–∞–π –≤ —Å–º—ã—Å–ª (¬´1‚Äì5 —ç—Ç–∞–∂–Ω–æ—Å—Ç—å¬ª ‚Üí ¬´–Ω–µ–≤—ã—Å–æ–∫–∞—è —ç—Ç–∞–∂–Ω–æ—Å—Ç—å¬ª –∏ —Ç.–ø.).

4) –ú–∏–∫—Ä–æ-–±–ª–æ–∫–∏ (–≤—ã–≤–æ–¥–∏ —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ –µ—Å—Ç—å —Ñ–∞–∫—Ç—ã)
‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: –æ–±—â–∞—è –ø–ª–æ—â–∞–¥—å {total_area} –º¬≤, –∫—É—Ö–Ω—è {kitchen_area} –º¬≤, –∫–æ–º–Ω–∞—Ç—ã {rooms}, —ç—Ç–∞–∂ {floor_number} / {building_floors}, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ {amenities}.
‚Äî –î–æ–º/–ñ–ö: {in_complex_label}, –∫–ª–∞—Å—Å/—Ç–∏–ø: {type_label} {apt_class_label}.
‚Äî –õ–æ–∫–∞—Ü–∏—è: {location} (–∏ ¬´{area_label}¬ª, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ—Å—ë—Ç —Å–º—ã—Å–ª).

5) –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏ (–∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É)
‚Äî –°–¥–µ–ª–∫–∞: {deal_label}. –ï—Å–ª–∏ –µ—Å—Ç—å –∏–ø–æ—Ç–µ–∫–∞/—Å—Ä–æ–∫ —Å–¥–∞—á–∏/—Å–ø–æ—Å–æ–± –ø—Ä–æ–¥–∞–∂–∏/–∏–Ω–æ–µ –≤ EXTRAS ‚Äî —É–ø–æ–º—è–Ω–∏, –Ω–æ –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∞.
‚Äî –ò–∑–±–µ–≥–∞–π –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π ¬´–±–µ–∑ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–∏–π/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫¬ª, –µ—Å–ª–∏ —Ç–∞–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –Ω–µ—Ç.

6) CTA
‚Äî 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞: —Å–æ–∑–≤–æ–Ω/–ø—Ä–æ—Å–º–æ—Ç—Ä/–¥–æ–ø —Ñ–æ—Ç–æ. –ù–∏–∫–∞–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è.

–î–∞–Ω–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–æ —Å–º—ã—Å–ª—É, –±–µ–∑ –≤—ã–≤–æ–¥–∞ ¬´‚Äî¬ª):
‚Äî –¢–∏–ø: {type_label}
‚Äî –ö–ª–∞—Å—Å: {apt_class_label}
‚Äî –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–ñ–ö: {in_complex_label}
‚Äî –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–æ–±—â–µ–µ): {area_label}
‚Äî –õ–æ–∫–∞—Ü–∏—è (—Ä–∞–π–æ–Ω/–º–µ—Ç—Ä–æ/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç): {location}
‚Äî –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: {total_area} –º¬≤
‚Äî –ö—É—Ö–Ω—è: {kitchen_area} –º¬≤
‚Äî –≠—Ç–∞–∂ / –≠—Ç–∞–∂–Ω–æ—Å—Ç—å: {floor_number} / {building_floors}
‚Äî –ö–æ–º–Ω–∞—Ç: {rooms}
‚Äî –ì–æ–¥ / –°–æ—Å—Ç–æ—è–Ω–∏–µ: {year_state}
‚Äî –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: {utilities}
‚Äî –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏/—É–¥–æ–±—Å—Ç–≤–∞: {amenities}
‚Äî –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}

–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:
‚Äî –ù–∏–∫–∞–∫–∏—Ö –ø—É—Å—Ç—ã—Ö ¬´—à–∞–ø–æ–∫¬ª –∏ –∑–∞–≥–ª—É—à–µ–∫. –ë–ª–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–º—ã—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.
‚Äî –ü–µ—Ä–µ–≤–æ–¥–∏ –≤–≤–æ–¥–Ω—ã–µ –∫–æ–¥—ã/—è—Ä–ª—ã–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∞–ª–∫–æ–Ω–æ–≤¬ª, ¬´–æ–∫–Ω–∞ –Ω–∞ —Å–æ–ª–Ω–µ—á–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É¬ª) –≤ –ø–æ–ª—å–∑—É –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.
‚Äî –ò—Ç–æ–≥ ‚Äî —Ü–µ–ª—å–Ω—ã–π –ø—Ä–æ–¥–∞—é—â–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.
"""


# ------------------ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã ------------------
# –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Äî –ü–†–û–î–ê–ñ–ê
DESCRIPTION_PROMPT_FLAT_SALE_RU = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä, –¥–æ–º–æ–≤ –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π,
–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–µ–±—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –æ–±—ä–µ–∫—Ç–∞ –∏ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–¥–µ–ª–∫–µ.

# A. –ö–∞—Ä–∫–∞—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–æ–≤)

1. **–ö–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (–∑–∞–≥–æ–ª–æ–≤–æ–∫)** ‚Äî 1 —Å—Ç—Ä–æ–∫–∞
2. **–ê–¥—Ä–µ—Å–∞—Ç –∏ –ø—Ä–∏—á–∏–Ω–∞ (–ª–∏–¥)** ‚Äî 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
3. **–ü–ª–∞–Ω –∏ –º–µ—Ç—Ä—ã (–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ)** ‚Äî —Ñ–∞–∫—Ç—ã ‚Üí –ø–æ–ª—å–∑–∞
4. **–î–æ–º –∏ –ø–æ–¥—ä–µ–∑–¥ (–æ –∑–¥–∞–Ω–∏–∏/–ñ–ö)** ‚Äî —Ñ–∞–∫—Ç—ã ‚Üí –ø–æ–ª—å–∑–∞
5. **–õ–æ–∫–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã, —Å–µ—Ä–≤–∏—Å—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
6. **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ)** ‚Äî 4‚Äì7 –ø—É–Ω–∫—Ç–æ–≤
7. **–§–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏** ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –∏ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
8. **–ù—é–∞–Ω—Å—ã** ‚Äî 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ {comment}
9. **–ö–æ–Ω—Ç–∞–∫—Ç** ‚Äî 1 –∫–æ—Ä–æ—Ç–∫–∞—è —Ñ—Ä–∞–∑–∞ –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è
"""

# –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Äî –ê–†–ï–ù–î–ê
DESCRIPTION_PROMPT_FLAT_RENT_RU = """
–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏. –ü–∏—à–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–± –∞—Ä–µ–Ω–¥–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã.

–ü—Ä–∞–≤–∏–ª–∞:
1) ¬´–§–∞–∫—Ç ‚Üí –∫–æ–º—Ñ–æ—Ä—Ç/—Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏¬ª. –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π –±—ã—Ç, —Ç–∏—à–∏–Ω—É, —É–¥–æ–±—Å—Ç–≤–∞, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.
2) –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π. –ë–µ–∑ –∫–ª–∏—à–µ, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è.
3) –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí –ª–∏–¥ ‚Üí 4‚Äì6 –º–∞—Ä–∫–µ—Ä–æ–≤ –≤—ã–≥–æ–¥ ‚Üí –º–∏–∫—Ä–æ-–±–ª–æ–∫–∏ (–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞/–î–æ–º/–õ–æ–∫–∞—Ü–∏—è) ‚Üí –£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã (—Å—Ä–æ–∫, –∑–∞–ª–æ–≥, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ, –ø—Ä–∞–≤–∏–ª–∞) ‚Üí CTA –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä.
4) –ù–µ —É–ø–æ–º–∏–Ω–∞–π –∏–ø–æ—Ç–µ–∫—É/–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏. –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π; –ø—É—Å—Ç—ã–µ –ø–æ–ª—è –Ω–µ –≤—ã–≤–æ–¥–∏.
5) –ß–∏—Å–ª–∞: –º¬≤, —ç—Ç–∞–∂/—ç—Ç–∞–∂–Ω–æ—Å—Ç—å. –î–∏–∞–ø–∞–∑–æ–Ω—ã –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏–≤–∞–π.
6) –û–±—ä—ë–º ~900‚Äì1400 –∑–Ω–∞–∫–æ–≤.
–í—ã–≤–æ–¥–∏ —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç.
"""

# –ó–∞–≥–æ—Ä–æ–¥–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (–¥–æ–º/–¥–∞—á–∞/—É—á–∞—Å—Ç–æ–∫)
DESCRIPTION_PROMPT_COUNTRY_RU = """
–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–æ –∑–∞–≥–æ—Ä–æ–¥–Ω–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏. –ü–æ–∫–∞–∂–∏ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏: –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≤–æ–∑–¥—É—Ö, —É—á–∞—Å—Ç–æ–∫, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏.

–ü—Ä–∞–≤–∏–ª–∞:
1) –§–∞–∫—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –≤—ã–≥–æ–¥—ã: –ø–ª–æ—â–∞–¥—å –¥–æ–º–∞/—É—á–∞—Å—Ç–∫–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–ª–∏, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –ø–æ–¥—ä–µ–∑–¥, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –æ–∫—Ä—É–∂–µ–Ω–∏–µ.
2) –¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π. –ë–µ–∑ —à—Ç–∞–º–ø–æ–≤.
3) –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí –ª–∏–¥ ‚Üí 4‚Äì6 –≤—ã–≥–æ–¥-–º–∞—Ä–∫–µ—Ä–æ–≤ ‚Üí –º–∏–∫—Ä–æ-–±–ª–æ–∫–∏ (–î–æ–º/–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞/–£—á–∞—Å—Ç–æ–∫/–õ–æ–∫–∞—Ü–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–∞–Ω–Ω—ã—Ö) ‚Üí –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏ ‚Üí CTA.
4) –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π; –ø—É—Å—Ç—ã–µ –±–ª–æ–∫–∏ –Ω–µ –≤—ã–≤–æ–¥–∏.
5) –û–±—ä—ë–º ~900‚Äì1400 –∑–Ω–∞–∫–æ–≤.
–°—Ä–∞–∑—É –≤—ã–≤–æ–¥–∏ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç.
"""

# –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (–æ—Ñ–∏—Å/street retail/—Å–∫–ª–∞–¥ –∏ –ø—Ä.)
DESCRIPTION_PROMPT_COMMERCIAL_RU = """
–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏. –§–æ–∫—É—Å –Ω–∞ –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∏: —Ç—Ä–∞—Ñ–∏–∫, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –º–æ—â–Ω–æ—Å—Ç–∏, –≤–∏—Ç—Ä–∏–Ω—ã.

–ü—Ä–∞–≤–∏–ª–∞:
1) –í—ã–≥–æ–¥—ã —á–µ—Ä–µ–∑ —Ñ–∞–∫—Ç—ã: –ª–æ–∫–∞—Ü–∏—è/–ø–æ—Ç–æ–∫, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç/–ø–∞—Ä–∫–æ–≤–∫–∞, –≤—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤, –≤—Ö–æ–¥–Ω—ã–µ –≥—Ä—É–ø–ø—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –Ω–∞–≥—Ä—É–∑–∫–∞/–º–æ—â–Ω–æ—Å—Ç—å, –≤–∏—Ç—Ä–∏–Ω–Ω–æ—Å—Ç—å.
2) –¢–æ–Ω: –¥–µ–ª–æ–≤–æ–π –∏ –ø—Ä–µ–¥–º–µ—Ç–Ω—ã–π, –±–µ–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —à—Ç–∞–º–ø–æ–≤.
3) –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí –ª–∏–¥ ‚Üí 4‚Äì6 –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Üí –º–∏–∫—Ä–æ-–±–ª–æ–∫–∏ (–ü–æ–º–µ—â–µ–Ω–∏–µ/–ó–¥–∞–Ω–∏–µ/–õ–æ–∫–∞—Ü–∏—è ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ) ‚Üí –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏ (–∞—Ä–µ–Ω–¥–∞/–ø—Ä–æ–¥–∞–∂–∞, –ù–î–°, –∫–∞–Ω–∏–∫—É–ª—ã, e.t.c.) ‚Üí CTA (–ø—Ä–æ—Å–º–æ—Ç—Ä/–±—Ä–∏—Ñ).
4) –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π; –ø—É—Å—Ç—ã–µ –ø–æ–ª—è –Ω–µ –≤—ã–≤–æ–¥–∏.
5) –û–±—ä—ë–º ~900‚Äì1400 –∑–Ω–∞–∫–æ–≤.
–í—ã–≤–æ–¥–∏ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π.
"""

# Fallback
DESCRIPTION_PROMPT_DEFAULT_RU = """
–¢—ã ‚Äî —Å–∏–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –±—ã—Å—Ç—Ä–æ –≤–ª—é–±–ª—è—Ç—å —á–∏—Ç–∞—Ç–µ–ª—è –≤ –æ–±—ä–µ–∫—Ç
–∏ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –≤—ã–≥–æ–¥—ã –≤–ª–∞–¥–µ–Ω–∏—è (–Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å —Ñ–∞–∫—Ç—ã).

–ñ—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:
1) –ü–∏—à–∏ –∂–∏–≤–æ, –ø—Ä–æ—Å—Ç—ã–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º. –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã, ¬´–≤–æ–∑–¥—É—Ö¬ª, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞.
2) –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç ‚Üí —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –≤—ã–≥–æ–¥—É. –ù–µ ¬´–ø–æ—Ç–æ–ª–∫–∏ 3.2 –º¬ª, –∞ ¬´–≤—ã—Å–æ–∫–∏–µ –ø–æ—Ç–æ–ª–∫–∏ ‚Äî –±–æ–ª—å—à–µ —Å–≤–µ—Ç–∞ –∏ –≤–æ–∑–¥—É—Ö–∞¬ª.
3) –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ —Å—Ç–æ–∏—Ç ¬´‚Äî¬ª, –ø—Ä–æ—Å—Ç–æ –æ–ø—É—Å—Ç–∏ —ç—Ç–æ –º–µ—Å—Ç–æ –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫.
4) –ù–∏–∫–∞–∫–∏—Ö –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ ¬´–¥–æ–º —Ö–æ—Ä–æ—à–∏–π/–∫–≤–∞—Ä—Ç–∏—Ä–∞ —É—é—Ç–Ω–∞—è¬ª. –ù–∏–∫–∞–∫–∏—Ö —à—Ç–∞–º–ø–æ–≤ ¬´–ª—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞¬ª.
5) –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è: —Ü–µ–ø–ª—è—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí —Å–∏–ª—å–Ω—ã–π –ª–∏–¥-–∞–±–∑–∞—Ü (1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) ‚Üí 4‚Äì6 –≤—ã–≥–æ–¥-–º–∞—Ä–∫–µ—Ä–æ–≤ ‚Üí
   1‚Äì3 –º–∏–∫—Ä–æ-–±–ª–æ–∫–∞ –ø–æ —Ç–µ–º–µ (–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –î–æ–º/–ñ–ö, –õ–æ–∫–∞—Ü–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ) ‚Üí –£—Å–ª–æ–≤–∏—è —Å–¥–µ–ª–∫–∏ ‚Üí –º–æ—â–Ω—ã–π CTA.
6) –ü–∏—à–∏ ¬´–≤—ã¬ª, –Ω–µ ¬´–≤—ã —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã¬ª. –ë–µ–∑ –∫–∞–ø—Å–∞, –±–µ–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤.
7) –ù–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ: –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ ¬´‚Äî¬ª –∏–ª–∏ –ø—É—Å—Ç–æ ‚Äî –Ω–µ –≤—ã–≤–æ–¥–∏ —Å—Ç—Ä–æ–∫—É/–º–∞—Ä–∫–µ—Ä/–±–ª–æ–∫.
8) –ß–∏—Å–ª–∞ —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏: –º¬≤, —ç—Ç–∞–∂ / —ç—Ç–∞–∂–Ω–æ—Å—Ç—å. –î–∏–∞–ø–∞–∑–æ–Ω—ã –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏–≤–∞–π –ø–æ —Å–º—ã—Å–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–Ω–µ–≤—ã—Å–æ–∫–∞—è —ç—Ç–∞–∂–Ω–æ—Å—Ç—å¬ª).
9) –¢–æ–Ω –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –¥–ª—è ¬´–ü—Ä–æ–¥–∞–∂–∞¬ª –∏ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏/–∫–æ–º—Ñ–æ—Ä—Ç–∞ –¥–ª—è ¬´–ê—Ä–µ–Ω–¥–∞¬ª.
10) –î–ª–∏–Ω–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: ~900‚Äì1400 –∑–Ω–∞–∫–æ–≤ (–Ω–µ –æ–±—Ä–µ–∑–∞–π –º—ã—Å–ª–∏, –Ω–æ –¥–µ—Ä–∂–∏ —Ç–µ–º–ø).

–ü–∞–º—è—Ç–∫–∞ –æ —Å—Ç–∏–ª–µ:
‚Äî –î–∞–π —á–∏—Ç–∞—Ç–µ–ª—é –∫–∞—Ä—Ç–∏–Ω–∫—É: —Å–≤–µ—Ç, –≤–æ–∑–¥—É—Ö, —Ç–∏—à–∏–Ω–∞, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —á–µ—Ä–µ–∑ –ø–æ–ª—å–∑—É. 
‚Äî –ë–∞–ª–∞–Ω—Å: —ç–º–æ—Ü–∏—è + –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞. –ù–∏ –≥—Ä–∞–º–º–∞ —Ñ–∞–Ω—Ç–∞–∑–∏–π —Å–≤–µ—Ä—Ö –¥–∞–Ω–Ω—ã—Ö.
‚Äî –ú–µ–Ω—å—à–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤-¬´—à–∞–ø–æ–∫¬ª; –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ ‚Äî –º–∏–∫—Ä–æ-–±–ª–æ–∫–∏ —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –±–µ–∑ —ç–º–æ–¥–∑–∏.

–í—ã–≤–æ–¥–∏ —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫ —Ç–∏–ø–∞ ¬´–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ¬ª.
"""


# =====================================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –£–¢–ò–õ–ò–¢–´
# =====================================================================================
def _sanitize_format_template(s: str) -> str:
    """
    –î–µ–ª–∞–µ—Ç —à–∞–±–ª–æ–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –¥–ª—è str.format:
      ‚Äî –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ {name:...} —É–¥–∞–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç-—á–∞—Å—Ç—å (–≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–∫–æ–±–∫–∏) -> {name}
      ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–µ '{' –∏ '}' –≤–Ω–µ –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ -> '{{' / '}}'
    –î–æ–ø—É—Å—Ç–∏–º–æ–µ –∏–º—è: [a-zA-Z_][a-zA-Z0-9_]*
    """
    out: list[str] = []
    i = 0
    n = len(s)
    ident_re = re.compile(r'[a-zA-Z_][a-zA-Z0-9_]*')
    while i < n:
        ch = s[i]
        if ch == '{':
            # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ "{{"
            if i + 1 < n and s[i + 1] == '{':
                out.append('{{'); i += 2; continue
            # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å {identifier ...}
            j = i + 1
            m = ident_re.match(s, j)
            if not m:
                # –ù–µ –≤–∞–ª–∏–¥–Ω–æ–µ –Ω–∞—á–∞–ª–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º
                out.append('{{'); i += 1; continue
            name_end = m.end()
            name = s[j:name_end]
            if name_end < n and s[name_end] == '}':
                # –ü—Ä–æ—Å—Ç–æ–π {name}
                out.append('{'); out.append(name); out.append('}')
                i = name_end + 1; continue
            if name_end < n and s[name_end] == ':':
                # {name: ...} ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç-—á–∞—Å—Ç—å —Å —É—á—ë—Ç–æ–º –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–∫–æ–±–æ–∫
                k = name_end + 1
                depth = 0
                while k < n:
                    if s[k] == '{':
                        depth += 1
                    elif s[k] == '}':
                        if depth == 0:
                            # –∫–æ–Ω–µ—Ü —Ñ–æ—Ä–º–∞—Ç-—á–∞—Å—Ç–∏
                            out.append('{'); out.append(name); out.append('}')
                            k += 1
                            break
                        depth -= 1
                    k += 1
                else:
                    # –ù–µ –Ω–∞—à–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—É—é '{'
                    out.append('{{'); i += 1; continue
                i = k; continue
            # –ò–Ω–æ–π —Å–∏–º–≤–æ–ª –ø–æ—Å–ª–µ –∏–º–µ–Ω–∏ ‚Äî –Ω–µ —Ñ–æ—Ä–º–∞—Ç, —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º '{'
            out.append('{{'); i += 1; continue
        elif ch == '}':
            # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ "}}"
            if i + 1 < n and s[i + 1] == '}':
                out.append('}}'); i += 2; continue
            # –û–¥–∏–Ω–æ—á–Ω–∞—è –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è ‚Äî —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º
            out.append('}}'); i += 1; continue
        else:
            out.append(ch); i += 1
    return ''.join(out)

def _default_api_key() -> str:
    """
    –ö–ª—é—á –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë–º –∏–∑ config (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –ª–∏–±–æ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–∞–∫ –±—ç–∫–∞–ø.
    """
    return (OPENAI_API_KEY or os.getenv("OPENAI_API_KEY", "")).strip()


def validate_config() -> List[str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –≤–µ—â–∏. –¢–æ–Ω–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:
    ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–ª—é—á–∞ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ –ø—Ä–∏–¥—ë—Ç per-request –∫–ª—é—á.
    """
    issues: List[str] = []
    # soft check
    if not _default_api_key():
        issues.append("OPENAI_API_KEY not set (pass per-request key or set in config)")
    return issues


def _safe(val: Any) -> str:
    if val is None:
        return "‚Äî"
    if isinstance(val, bool):
        return "–î–∞" if val else "–ù–µ—Ç"
    if isinstance(val, (int, float)):
        try:
            return f"{val:.15g}"
        except Exception:
            return str(val)
    if isinstance(val, (list, tuple, set)):
        parts = [_safe(x) for x in val]
        parts = [p for p in parts if p and p != "‚Äî"]
        return ", ".join(parts) if parts else "‚Äî"
    s = str(val).strip()
    return s or "‚Äî"


def _label(m: Dict[str, str], key: Optional[str], default: str = "‚Äî") -> str:
    return m.get((key or "").strip(), default) if key else default


def _first_nonempty(*xs: Any) -> Any:
    for x in xs:
        if x not in (None, "", []):
            return x
    return None


# –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞-–∞–ª–∏–∞—Å–æ–≤: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∏ –Ω–æ–≤—ã–µ –∏ —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏
def _normalize_fields(raw: Dict[str, Any]) -> Dict[str, Any]:
    norm: Dict[str, Any] = {
        # –±–∞–∑–æ–≤—ã–µ
        "type": raw.get("type"),
        "deal_type": raw.get("deal_type"),  # sale | rent (–∏–∑ playbook)
        "apt_class": raw.get("apt_class"),
        "in_complex": raw.get("in_complex"),
        "area": raw.get("area"),
        "comment": raw.get("comment"),

        # –ø–ª–æ—Å–∫–æ—Å—Ç—å –∞–Ω–∫–µ—Ç—ã
        "total_area": _first_nonempty(raw.get("total_area")),
        "kitchen_area": _first_nonempty(raw.get("kitchen_area")),
        # —ç—Ç–∞–∂/—ç—Ç–∞–∂–Ω–æ—Å—Ç—å: –ø—Ä–∏–Ω–∏–º–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        "building_floors": _first_nonempty(raw.get("floors_total"), raw.get("building_floors")),
        "floor_number": _first_nonempty(raw.get("floor"), raw.get("floor_number")),
        "rooms": _first_nonempty(raw.get("rooms")),
        "year_state": _first_nonempty(raw.get("year_or_condition"), raw.get("year_state")),
        "utilities": _first_nonempty(raw.get("utilities")),
        "location": _first_nonempty(raw.get("location_exact"), raw.get("location")),
        "amenities": _first_nonempty(raw.get("features"), raw.get("amenities")),

        # –Ω–æ–≤—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (–∫–≤–∞—Ä—Ç–∏—Ä–∞)
        "flat_location_text": raw.get("flat_location_text"),
        "flat_infrastructure_text": raw.get("flat_infrastructure_text"),
        "flat_legal_text": raw.get("flat_legal_text"),

        # –∫–≤–∞—Ä—Ç–∏—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        "market": raw.get("market"),
        "completion_term": raw.get("completion_term"),
        "sale_method": raw.get("sale_method"),
        "mortgage_ok": raw.get("mortgage_ok"),
        "bathroom_type": raw.get("bathroom_type"),
        "windows": raw.get("windows"),
        "house_type": raw.get("house_type"),
        "lift": raw.get("lift"),
        "parking": raw.get("parking"),
        "renovation": raw.get("renovation"),
        "layout": raw.get("layout"),
        "balcony": raw.get("balcony"),
        "ceiling_height_m": raw.get("ceiling_height_m"),

        # –∑–∞–≥–æ—Ä–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        "country_object_type": raw.get("country_object_type"),
        "country_house_area_m2": raw.get("country_house_area_m2"),
        "country_plot_area_sotki": raw.get("country_plot_area_sotki"),
        "country_distance_km": raw.get("country_distance_km"),
        "country_floors": raw.get("country_floors"),
        "country_rooms": raw.get("country_rooms"),
        "country_land_category_house": raw.get("country_land_category_house"),
        "country_renovation": raw.get("country_renovation"),
        "country_toilet": raw.get("country_toilet"),
        "country_utilities": raw.get("country_utilities"),
        "country_leisure": raw.get("country_leisure"),
        "country_wall_material": raw.get("country_wall_material"),
        "country_parking": raw.get("country_parking"),
        "country_transport": raw.get("country_transport"),
        "country_land_category_plot": raw.get("country_land_category_plot"),
        "country_communications_plot": raw.get("country_communications_plot"),

        # –∫–æ–º–º–µ—Ä—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ comment-–∫–æ–Ω—Ç–µ–∫—Å—Ç
        "comm_object_type": raw.get("comm_object_type"),
        "land_area": raw.get("land_area"),
        "comm_building_type": raw.get("comm_building_type"),
        "comm_whole_object": raw.get("comm_whole_object"),
        "comm_finish": raw.get("comm_finish"),
        "comm_entrance": raw.get("comm_entrance"),
        "comm_parking": raw.get("comm_parking"),
        "comm_layout": raw.get("comm_layout"),
    }
    # 1) –ï—Å–ª–∏ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø—Ä–∏—à—ë–ª ¬´—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã¬ª (—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è –º–µ—Ç–∫–∞),
    #    –∞ —è–≤–Ω–æ–≥–æ year_state –Ω–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–Ω–æ –µ–≥–æ.
    if not norm.get("year_state") and raw.get("apt_condition"):
        norm["year_state"] = raw.get("apt_condition")

    # 2) –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–æ–≤ –∏–∑ playbook:
    #    —Ç–∞–º –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ú–ï–¢–ö–ò –ª–∏–±–æ –∫–æ–¥—ã (–≤ country_*). –ù–∞ —É—Ä–æ–≤–Ω–µ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–º
    #    —É–¥–æ–±–Ω–µ–µ –∏–º–µ—Ç—å ¬´—á–µ–ª–æ–≤–µ—á–µ—Å–∫—É—é —Å—Ç—Ä–æ–∫—É¬ª (–¥–ª—è —à–∞–±–ª–æ–Ω–∞ user).
    def _join_labels(v: Any) -> Optional[str]:
        if isinstance(v, (list, tuple, set)):
            parts = [str(x).strip() for x in v if str(x).strip()]
            return ", ".join(parts) if parts else None
        return str(v).strip() if v else None

    for multi_key in (
            "country_utilities", "country_leisure", "country_communications_plot"
    ):
        if multi_key in raw:
            j = _join_labels(raw.get(multi_key))
            if j:
                # –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä—ã –∫–∞–∫ —á–∞—Å—Ç—å ¬´–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π/—É–¥–æ–±—Å—Ç–≤¬ª —á–µ—Ä–µ–∑ comment
                # (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è ‚Äî –Ω–∏–∂–µ —à–∞–±–ª–æ–Ω –∏—Ö —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∞–∫ amenities/utilities)
                norm[multi_key] = j

    # 3) –£–¥–∞–ª–∏–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ "‚Äî" (–¥–ª—è —á–∏—Å—Ç–æ—Ç—ã payload)
    for k, v in list(norm.items()):
        if v in ("", "‚Äî"):
            norm[k] = None

    # 4) –î–µ—Ä–∏–≤–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ–ø–æ–ª–Ω—ã—Ö –∞–Ω–∫–µ—Ç
    # 4.1) –ï—Å–ª–∏ —ç—Ç–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –∏ —É–∫–∞–∑–∞–Ω ¬´market=–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞¬ª, –Ω–æ –Ω–µ –∑–∞–¥–∞–Ω–æ in_complex ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏–º "yes"
    if (norm.get("type") or "").strip().lower() == "flat" and not norm.get("in_complex"):
        if str(raw.get("market") or "").strip().lower() in {"–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞", "new", "newbuild", "–Ω–æ–≤–∞—è"}:
            norm["in_complex"] = "yes"

    # 4.2) –ï—Å–ª–∏ –Ω–µ—Ç ¬´location¬ª, –Ω–æ –µ—Å—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞—è ¬´flat_location_text¬ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –∫–∞–∫ –ª–æ–∫–∞—Ü–∏—é
    if not norm.get("location") and raw.get("flat_location_text"):
        loc = str(raw.get("flat_location_text")).strip()
        if loc:
            norm["location"] = loc

    # –∑–∞—â–∏—Ç–∞ –æ—Ç ¬´–∏–ø–æ—Ç–µ–∫–∞/–ø—Ä–∞–≤–æ¬ª –ø—Ä–∏ –∞—Ä–µ–Ω–¥–µ: —é—Ä.—Ç–µ–∫—Å—Ç –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
    if (norm.get("deal_type") or "").strip().lower() != "sale":
        # –µ—Å–ª–∏ –ø—Ä–∏–ª–µ—Ç–µ–ª–æ –ø–æ –æ—à–∏–±–∫–µ ‚Äî –≤—ã—á–∏—Å—Ç–∏–º, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞–¥–∞–ª–æ –≤ —à–∞–±–ª–æ–Ω
        norm["flat_legal_text"] = None
    return norm


# =====================================================================================
# –§–ê–ë–†–ò–ö–ê –ü–†–û–ú–ü–¢–ê (Description)
# =====================================================================================

def _select_description_user_template(fields: Dict[str, Any]) -> str:
    """
    –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ TEMPLATE –ø–æ —Ç–∏–ø—É/—Å–¥–µ–ª–∫–µ:
     - flat + sale  -> DESCRIPTION_USER_TEMPLATE_FLAT_SALE_RU
     - flat + rent  -> DESCRIPTION_USER_TEMPLATE_FLAT_RENT_RU
     - country/zagorod -> DESCRIPTION_USER_TEMPLATE_COUNTRY_RU
     - commercial/comm/office/land -> DESCRIPTION_USER_TEMPLATE_COMMERCIAL_RU
     - –∏–Ω–∞—á–µ -> DESCRIPTION_USER_TEMPLATE_RU (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
    """
    t = str(fields.get("type") or "").strip().lower()
    deal = str(fields.get("deal_type") or "").strip().lower()
    
    if t == "flat":
        return DESCRIPTION_USER_TEMPLATE_FLAT_RENT_RU if deal == "rent" else DESCRIPTION_USER_TEMPLATE_FLAT_SALE_RU
    
    if t in {"country", "zagorod"}:
        return DESCRIPTION_USER_TEMPLATE_COUNTRY_RU
    
    if t in {"commercial", "comm", "office", "land"}:
        return DESCRIPTION_USER_TEMPLATE_COMMERCIAL_RU
    
    return DESCRIPTION_USER_TEMPLATE_RU
def _select_description_prompt(fields: Dict[str, Any]) -> str:
    """
    –í—ã–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –ø–æ —Ç–∏–ø—É/—Å–¥–µ–ª–∫–µ:
     - flat + sale  -> DESCRIPTION_PROMPT_FLAT_SALE_RU
     - flat + rent  -> DESCRIPTION_PROMPT_FLAT_RENT_RU
     - country/zagorod -> DESCRIPTION_PROMPT_COUNTRY_RU
     - commercial/comm/office/land -> DESCRIPTION_PROMPT_COMMERCIAL_RU
     - –∏–Ω–∞—á–µ -> DESCRIPTION_PROMPT_DEFAULT_RU
    """
    t = str(fields.get("type") or "").strip().lower()
    deal = str(fields.get("deal_type") or "").strip().lower()
    
    if t == "flat":
        if deal == "rent":
            return DESCRIPTION_PROMPT_FLAT_RENT_RU
        # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã ‚Äî –ø—Ä–æ–¥–∞–∂–∞
        return DESCRIPTION_PROMPT_FLAT_SALE_RU
    
    if t in {"country", "zagorod"}:
        return DESCRIPTION_PROMPT_COUNTRY_RU
    
    if t in {"commercial", "comm", "office", "land"}:
        # land: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π (—É—á–∞—Å—Ç–æ–∫ –ø–æ–¥ –±–∏–∑–Ω–µ—Å),
        # –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç.
        return DESCRIPTION_PROMPT_COMMERCIAL_RU
    
    return DESCRIPTION_PROMPT_DEFAULT_RU

def build_description_request_from_fields(*, fields: Dict[str, Any], model: Optional[str] = None) -> Dict[str, Any]:
    """
    –°–æ–∑–¥–∞–µ—Ç payload –¥–ª—è OpenAI –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –ø–æ–ª–µ–π –∞–Ω–∫–µ—Ç—ã.
    """
    normalized = _normalize_fields(fields)
    user_message = compose_description_user_message(normalized)
    use_model = model or DESCRIPTION_MODEL
    system_prompt = _select_description_prompt(normalized)

    payload = {
        "model": use_model,
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_message},
        ]
    }
    return payload


def compose_description_user_message(fields: Dict[str, Any]) -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ø–æ–ª–µ–π –∞–Ω–∫–µ—Ç—ã (—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π).
    """
    t_key = fields.get("type")
    deal_type_raw = str(fields.get("deal_type") or "").strip().lower()
    c_key = fields.get("apt_class") if (t_key == "flat") else None
    x_key = fields.get("in_complex")
    a_key = fields.get("area")

    deal_label = {"sale": "–ü—Ä–æ–¥–∞–∂–∞", "rent": "–ê—Ä–µ–Ω–¥–∞"}.get(str(fields.get("deal_type") or "").strip(), "‚Äî")

    # –í—ã–±–∏—Ä–∞–µ–º USER-TEMPLATE —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–∏–ø—É/—Å–¥–µ–ª–∫–µ
    user_template = _select_description_user_template(fields)

    user_payload = {
        "deal_label": deal_label,
        "type_label": _label(DESCRIPTION_TYPES, t_key),
        "apt_class_label": _label(DESCRIPTION_CLASSES, c_key) if c_key else "‚Äî",
        "in_complex_label": _label(DESCRIPTION_COMPLEX, x_key),
        "area_label": _label(DESCRIPTION_AREA, a_key),

        "location": _safe(fields.get("location")),
        "total_area": _safe(fields.get("total_area")),
        "kitchen_area": _safe(fields.get("kitchen_area")),
        "floor_number": _safe(fields.get("floor_number")),
        "building_floors": _safe(fields.get("building_floors")),
        "rooms": _safe(fields.get("rooms")),
        "year_state": _safe(fields.get("year_state")),
        "utilities": _safe(fields.get("utilities")),
        "amenities": _safe(fields.get("amenities")),
        "comment": _safe(fields.get("comment")),
        # –Ω–æ–≤. —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (–∫–≤–∞—Ä—Ç–∏—Ä–∞)
        "flat_location_text": _safe(fields.get("flat_location_text")),
        "flat_infrastructure_text": _safe(fields.get("flat_infrastructure_text")),
        "flat_legal_text": _safe(fields.get("flat_legal_text")),

        # –ü–†–û–î–ê–ñ–ê/–∫–≤–∞—Ä—Ç–∏—Ä–∞ ‚Äî —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º –≤ —à–∞–±–ª–æ–Ω, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ EXTRAS
        "market": _safe(fields.get("market")),
        "completion_term": _safe(fields.get("completion_term")),
        "sale_method": _safe(fields.get("sale_method")),
        "mortgage_ok": (_safe(fields.get("mortgage_ok")) if deal_type_raw == "sale" else "‚Äî"),

        # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ ¬´–ø–æ–Ω—è—Ç–Ω—ã–µ¬ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–≤–∞—Ä—Ç–∏—Ä—ã, —á—Ç–æ–±—ã —à–∞–±–ª–æ–Ω –º–æ–≥ –∏—Ö –≤—Å—Ç—Ä–æ–∏—Ç—å
        "bathroom_type": _safe(fields.get("bathroom_type")),
        "windows": _safe(fields.get("windows")),
        "house_type": _safe(fields.get("house_type")),
        "lift": _safe(fields.get("lift")),
        "parking": _safe(fields.get("parking")),
        "renovation": _safe(fields.get("renovation")),
        "layout": _safe(fields.get("layout")),
        "balcony": _safe(fields.get("balcony")),
        "ceiling_height_m": _safe(fields.get("ceiling_height_m")),
    }

    # –î–æ–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–∫–≤–∞—Ä—Ç–∏—Ä–∞/–∑–∞–≥–æ—Ä–æ–¥/–∫–æ–º–º–µ—Ä—Ü–∏—è) ‚Äî –≤ EXTRAS,
    # —á—Ç–æ–±—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—è –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ—Ç–∫—É.
    extras: Dict[str, Any] = {}
    # –ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–π –¥–ª—è EXTRAS
    extras_keys = [
        # –∫–≤–∞—Ä—Ç–∏—Ä–∞
        "market", "completion_term", "sale_method",
        # "mortgage_ok" ‚Äî –Ω–∏–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
        "bathroom_type", "windows", "house_type", "lift", "parking",
        "renovation", "layout", "balcony", "ceiling_height_m",
        # –∑–∞–≥–æ—Ä–æ–¥
        "country_object_type", "country_house_area_m2", "country_plot_area_sotki", "country_distance_km",
        "country_floors", "country_rooms", "country_land_category_house", "country_renovation", "country_toilet",
        "country_utilities", "country_leisure", "country_wall_material", "country_parking", "country_transport",
        "country_land_category_plot", "country_communications_plot",
        # –∫–æ–º–º–µ—Ä—Ü–∏—è
        "comm_object_type", "land_area", "comm_building_type", "comm_whole_object", "comm_finish", "comm_entrance",
        "comm_parking", "comm_layout",
    ]
    if deal_type_raw != "rent":
        extras_keys.insert(3, "mortgage_ok")  # —Ä–∞–∑—Ä–µ—à–∞–µ–º –∏–ø–æ—Ç–µ–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏

    for k in extras_keys:
        v = fields.get(k, None)
        if v not in (None, "", [], "‚Äî"):
            extras[k] = v

    if extras:
        extras_str = ", ".join(f"{kk}={_safe(vv)}" for kk, vv in extras.items() if _safe(vv) != "‚Äî")
        user_payload["comment"] = (
                    user_payload["comment"] + ((" | EXTRAS: " + extras_str) if extras_str else "")).strip()

    # NB: –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –ª–æ–∫–∞—Ü–∏–∏/–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã/—é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã
    # –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —à–∞–±–ª–æ–Ω —á–µ—Ä–µ–∑ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã; –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º –∏—Ö –≤ EXTRAS.
    # (–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ EXTRAS –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ñ–ª–∞–≥–æ–º/–Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π.)

    # –î–æ–±–∞–≤–∏–º —Å–¥–µ–ª–∫—É –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π TEMPLATE
    msg = ""
    msg += f"‚Äî –°–¥–µ–ª–∫–∞: {user_payload['deal_label']}\n"
    msg += user_template
    # –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω: —É–±–∏—Ä–∞–µ–º —Ñ–æ—Ä–º–∞—Ç-—Å–ø–µ–∫–∏ –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–∫–æ–±–∫–∏
    tmpl = _sanitize_format_template(msg)
    try:
        return tmpl.format(**user_payload)
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –∏ –¥–µ–ª–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–º–µ–Ω—É –±–µ–∑ format(),
        # —á—Ç–æ–±—ã –Ω–µ —Ä–æ–Ω—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑-–∑–∞ —à–∞–±–ª–æ–Ω–∞.
        logging.exception("compose_description_user_message: format failed, fallback is used: %s", e)
        out = tmpl
        for k, v in user_payload.items():
            out = out.replace("{" + k + "}", "" if v is None else str(v))
        return out


def send_description_generate_request_from_fields(
        fields: Dict[str, Any],
        *,
        model: Optional[str] = None,
        allow_fallback: bool = OPENAI_FALLBACK,
        api_key: Optional[str] = None,
) -> Tuple[str, str]:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π –∞–Ω–∫–µ—Ç—ã.
    """
    use_model = model or DESCRIPTION_MODEL
    payload = build_description_request_from_fields(fields=fields, model=use_model)
    return _send_with_fallback(
        payload,
        default_model=use_model,
        allow_fallback=allow_fallback,
        api_key=api_key
    )


def _post_callback(callback_url: str, payload: Dict[str, Any]) -> None:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ —à–ª—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ callback_url. –ù–µ –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Ä—É–∂—É.
    """
    log.info("Sending callback to URL: %s", callback_url)
    log.info("Callback payload: %s", json.dumps(payload, ensure_ascii=False, indent=2))
    try:
        # –Ω–µ–±–æ–ª—å—à–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è URL
        pr = urlparse(callback_url)
        if pr.scheme not in {"http", "https"}:
            raise ValueError("callback_url must be http/https")
        headers = {"Content-Type": "application/json"}
        response = requests.post(callback_url, data=json.dumps(payload), headers=headers, timeout=30)
        log.info("Callback sent successfully, status: %s, response: %s", response.status_code, response.text)
    except Exception as e:
        log.warning("Callback POST failed: %s", e)


# =====================================================================================
# PUBLIC ENTRYPOINT for thin controller
# =====================================================================================
def description_generate(req: Request):
    """
    –¢–æ–Ω–∫–∏–π –≤—Ö–æ–¥: —Ä–∞–∑–±–∏—Ä–∞–µ–º –∑–∞–ø—Ä–æ—Å (JSON/form), –±–µ—Ä—ë–º per-request API –∫–ª—é—á (–µ—Å–ª–∏ –µ—Å—Ç—å),
    –≤—ã–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π OpenAI-—Å–µ—Ä–≤–∏—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Flask-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –æ—Ç–≤–µ—Ç.
    –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Å—é–¥–∞: return description_module.description_generate(request).
    """
    # –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ API
    log.info("API request received - Method: %s, URL: %s", req.method, req.url)
    log.info("Request headers: %s", dict(req.headers))
    
    # –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –µ—Å–ª–∏ –Ω–µ—Ç env-–∫–ª—é—á–∞ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω per-request –∫–ª—é—á ‚Äî 500
    issues = validate_config()
    data = req.get_json(silent=True) or {}
    form = req.form or {}
    
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
    log.info("Request JSON data: %s", json.dumps(data, ensure_ascii=False, indent=2))
    log.info("Request form data: %s", dict(form))
    log.info("Request args: %s", dict(req.args))

    api_key = (
            req.headers.get("X-OpenAI-Api-Key")
            or (data.get("api_key") if isinstance(data, dict) else None)
            or req.args.get("api_key")
    )
    # –µ—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä—É–≥–∞–µ—Ç—Å—è –∏ –∫–ª—é—á —è–≤–Ω–æ –Ω–µ –ø—Ä–∏—à—ë–ª ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if issues and not api_key:
        fallback = _default_api_key()
        if not fallback:
            return jsonify({"error": "config", "detail": "; ".join(issues)}), 500
        api_key = fallback

    # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª—è –∞–Ω–∫–µ—Ç—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
    # 1) –ø–ª–æ—Å–∫–∏–π: {"type": "...", "deal_type": "...", ...}
    # 2) –≤–ª–æ–∂–µ–Ω–Ω—ã–π: {"fields": {...}, "callback_url": "...", ...}  ‚Üê –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ —à–ª—ë—Ç –±–æ—Ç
    fields: Dict[str, Any] = {}
    if isinstance(data, dict):
        if isinstance(data.get("fields"), dict):   # ‚Üê –Ω–æ–≤—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å
            fields.update(data.get("fields"))
        else:
            fields.update(data)
    for k in form.keys():
        fields[k] = form.get(k)

    # –õ–æ–≥–∏—Ä—É–µ–º –∏–º–µ–Ω–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –∞–Ω–∫–µ—Ç—ã (–±–µ–∑ —Å–ª—É–∂–µ–±–Ω—ã—Ö –∫–ª—é—á–µ–π)
    log.info("Collected fields (normalized): %s", json.dumps(fields, ensure_ascii=False, indent=2))

    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    t = (fields.get("type") or "").strip()
    if not t:
        return jsonify({"error": "bad_request", "detail": "field 'type' is required"}), 400

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    callback_url   = (data.get("callback_url") if isinstance(data, dict) else None) or req.args.get("callback_url")
    callback_token = (data.get("callback_token") if isinstance(data, dict) else None) or req.args.get("callback_token")
    cb_chat_id     = (data.get("chat_id") if isinstance(data, dict) else None) or req.args.get("chat_id")
    cb_msg_id      = (data.get("msg_id") if isinstance(data, dict) else None) or req.args.get("msg_id")

    debug_flag = req.args.get("debug") == "1"

    # –†–µ–∂–∏–º async callback
    if callback_url and cb_chat_id and cb_msg_id:
        try:
            chat_id = int(cb_chat_id)
            msg_id  = int(cb_msg_id)
        except Exception:
            return jsonify({"error": "bad_request", "detail": "chat_id and msg_id must be integers"}), 400

        def _bg():
            """–§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ POST —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ callback_url."""
            log.info("Starting async description generation for chat_id=%s, msg_id=%s", chat_id, msg_id)
            try:
                text, used_model = send_description_generate_request_from_fields(
                    fields=fields,
                    allow_fallback=True,
                    api_key=api_key,
                )
                payload = {
                    "chat_id": chat_id,
                    "msg_id": msg_id,
                    "text": text,
                    "error": "",
                    "token": callback_token or "",
                    # –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ –±–æ—Ç–µ (–æ–Ω —É–º–µ–µ—Ç –ø—Ä–∏–Ω—è—Ç—å fields)
                    "fields": fields,
                }
                log.info("Async generation completed successfully, sending callback to: %s", callback_url)
                log.info("Callback payload: %s", json.dumps(payload, ensure_ascii=False, indent=2))
                _post_callback(callback_url, payload)
            except Exception as e:
                log.exception("OpenAI error (description, async)")
                payload = {
                    "chat_id": chat_id,
                    "msg_id": msg_id,
                    "text": "",
                    "error": str(e),
                    "token": callback_token or "",
                    "fields": fields,
                }
                log.info("Async generation failed, sending error callback: %s", json.dumps(payload, ensure_ascii=False, indent=2))
                _post_callback(callback_url, payload)

        threading.Thread(target=_bg, daemon=True).start()
        # –ë—ã—Å—Ç—Ä—ã–π ACK, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ ¬´–∂–¥–∞–ª¬ª
        log.info("Async request accepted, returning 202")
        return jsonify({"accepted": True}), 202

    # –û–±—ã—á–Ω—ã–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    log.info("Starting sync description generation")
    try:
        text, used_model = send_description_generate_request_from_fields(
            fields=fields,
            allow_fallback=True,
            api_key=api_key,
        )
        body: Dict[str, Any] = {"text": text}
        if debug_flag:
            body["debug"] = {"model_used": used_model}
        log.info("Sync generation completed successfully, response: %s", json.dumps(body, ensure_ascii=False, indent=2))
        return jsonify(body), 200
    except Exception as e:
        log.exception("OpenAI error (description)")
        body: Dict[str, Any] = {"error": "openai_error", "detail": str(e)}
        if debug_flag:
            body["debug"] = {"model": DESCRIPTION_MODEL}
        log.info("Sync generation failed, error response: %s", json.dumps(body, ensure_ascii=False, indent=2))
        return jsonify(body), 502