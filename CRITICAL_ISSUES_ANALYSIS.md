# –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –±–∏–ª–ª–∏–Ω–≥–∞

## ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. UnboundLocalError –≤ subscription_mark_charged_for_user
**–ü—Ä–æ–±–ª–µ–º–∞**: `now_msk = now_msk()` –≤—ã–∑—ã–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º—ë–Ω, –ø—Ä–∏–≤–æ–¥—è –∫ –æ—à–∏–±–∫–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `now_msk_val = now_msk()`)

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
**–§–∞–π–ª**: `bot/handlers/payment_handler.py:992`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ —Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (`##await bot.send_photo(...)`), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏—è—Ö.
**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: 
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–Ω–∞—é—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∫–∞—Ä—Ç–æ–π
- –ù–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–ø–ª–∞—Ç—ã
- –ú–æ–≥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ö–æ–¥**:
```python
992|                        ##await bot.send_photo(chat_id=user_id_fail, photo=photo, caption=caption, parse_mode="Markdown")
```

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
**–§–∞–π–ª**: `bot/handlers/payment_handler.py:1133, 1284, 1350`
**–ü—Ä–æ–±–ª–µ–º–∞**: `_notify_after_payment` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö webhook'–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –°–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö webhook'–æ–≤

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Redis –∏–ª–∏ payment_log.

---

### 3. –í–æ–∑–º–æ–∂–Ω–æ–µ –¥–≤–æ–π–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ renewal –ø–ª–∞—Ç–µ–∂–∞—Ö
**–§–∞–π–ª**: `bot/handlers/payment_handler.py:1193-1284`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ renewal –ø–ª–∞—Ç–µ–∂–µ:
1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscription_mark_charged_for_user` (—Å—Ç—Ä–æ–∫–∞ 1193)
2. –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è —á–µ—Ä–µ–∑ `subscription_upsert` (—Å—Ç—Ä–æ–∫–∞ 1266)
3. –ó–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `_notify_after_payment` (—Å—Ç—Ä–æ–∫–∞ 1284)

–ï—Å–ª–∏ `subscription_mark_charged_for_user` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É, –Ω–æ –ø–æ—Ç–æ–º –æ–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ fallback –ª–æ–≥–∏–∫–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –Ω–æ –ª–æ–≥–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—Ç–∞–Ω–Ω–æ–π.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏), —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã.

---

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –∫—É–ª–¥–∞—É–Ω–∞
**–§–∞–π–ª**: `bot/handlers/payment_handler.py:670-679`
**–ü—Ä–æ–±–ª–µ–º–∞**: –í `_create_links_for_selection` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `status == "active"`, –Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å `canceled`, –Ω–æ –µ—â—ë –Ω–µ —É–¥–∞–ª–µ–Ω–∞. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç–æ–º—É, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–Ω–æ–≤–∞ –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –∫—É–ø–∏—Ç—å –∑–∞ 1 —Ä—É–±–ª—å, –¥–∞–∂–µ –µ—Å–ª–∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å canceled –ø–æ–¥–ø–∏—Å–∫–∞.

**–ö–æ–¥**:
```python
670|     has_active_subscription = False
671|     try:
672|         from bot.utils.billing_db import SessionLocal, Subscription
673|         with SessionLocal() as s:
674|             active_sub = (
675|                 s.query(Subscription)
676|                 .filter(Subscription.user_id == user_id, Subscription.status == "active")
677|                 .first()
678|             )
679|             has_active_subscription = active_sub is not None
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∫—É–ø–∏—Ç—å –∑–∞ 1 —Ä—É–±–ª—å –ø–æ–≤—Ç–æ—Ä–Ω–æ, –µ—Å–ª–∏ –µ–≥–æ –ø–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ canceled, –Ω–æ –Ω–µ —É–¥–∞–ª–µ–Ω–∞.

---

### 5. –ö—É–ª–¥–∞—É–Ω –º–æ–∂–µ—Ç –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å renewal –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
**–§–∞–π–ª**: `bot/utils/database.py:318-384`
**–ü—Ä–æ–±–ª–µ–º–∞**: `get_last_purchase_action_date` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `last_charge_at` –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏, –Ω–æ –µ—Å–ª–∏ `subscription_mark_charged_for_user` –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è UnboundLocalError), `last_charge_at` –º–æ–∂–µ—Ç –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è, –∏ –∫—É–ª–¥–∞—É–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–°—Ç–∞—Ç—É—Å**: –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º UnboundLocalError, –Ω–æ —Å—Ç–æ–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `PaymentLog.created_at` –¥–ª—è renewal –ø–ª–∞—Ç–µ–∂–µ–π –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.

---

### 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
**–§–∞–π–ª**: `bot/utils/notification.py:609-618`
**–ü—Ä–æ–±–ª–µ–º–∞**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º (`pre_renew`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á `f"notif:paid:{uid}:pre:{epoch_key}"`, –≥–¥–µ `epoch_key = int(nca.timestamp())`. –ï—Å–ª–∏ `next_charge_at` –∏–∑–º–µ–Ω–∏—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞), –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ `next_charge_at`, –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ `next_charge_at`.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω –∏ `next_charge_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "—Å–∫–æ—Ä–æ —Å–ø–∏—Å–∞–Ω–∏–µ" —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è.

**–ö–æ–¥**:
```python
610|         if next_charge_at is not None:
611|             nca = from_db_naive(next_charge_at) if next_charge_at else None
612|             delta_s = (nca - now).total_seconds()
613|             if 0 < delta_s <= 24 * 3600:
614|                 epoch_key = int(nca.timestamp())
615|                 if await _send_text_once(bot, uid, f"notif:paid:{uid}:pre:{epoch_key}", TXT_PAID_PRE_RENEW):
```

---

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π –≤ billing_loop
**–§–∞–π–ª**: `bot/run.py:270-286`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `created` –∏ —Å `payment_id != None`. –ù–æ –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –±—ã–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ webhook –µ—â—ë –Ω–µ –ø—Ä–∏—à—ë–ª, –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: Race condition –º–µ–∂–¥—É —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ–º webhook –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –æ–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.

**–ö–æ–¥**:
```python
274|                             existing_attempt = (
275|                                 s.query(ChargeAttempt)
276|                                 .filter(
277|                                     ChargeAttempt.subscription_id == subscription_id,
278|                                     ChargeAttempt.status == "created",
279|                                     ChargeAttempt.payment_id.isnot(None)
280|                                 )
281|                                 .first()
282|                             )
```

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–∞–∫–∂–µ –ø–æ–ø—ã—Ç–∫–∏ –±–µ–∑ `payment_id`, –Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–∞–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç).

---

### 8. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ canceled –ø–æ–¥–ø–∏—Å–æ–∫ –ø—Ä–∏ renewal
**–§–∞–π–ª**: `bot/handlers/payment_handler.py:1200-1242`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ renewal –ø–ª–∞—Ç–µ–∂–µ, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç canceled –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∏—Ö. –ù–æ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `pm_token` –≤–∞–ª–∏–¥–µ–Ω –∏ –Ω–µ –∏—Å—Ç—ë–∫.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∫–∞—Ä—Ç—ã –∏—Å—Ç—ë–∫, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, —Å–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.

---

## üü° –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 9. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ —Å–ø–∏—Å–∞–Ω–∏–π
**–§–∞–π–ª**: `bot/run.py:306-308`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–≥–¥–∞ `precharge_guard_and_attempt` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `"Skip recurring: guard blocked"`, –Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏—á–∏–Ω–∞ (–∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ —â–∏—Ç —Å—Ä–∞–±–æ—Ç–∞–ª).

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å, –ø–æ—á–µ–º—É —Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç.

---

### 10. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
**–§–∞–π–ª**: `bot/run.py:324-359`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `failed`, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –±—ã–ª–∞ –ª–∏ –æ–Ω–∞ —É–∂–µ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ `failed` –≤ `youmoney.charge_saved_method`.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –î–≤–æ–π–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ race condition.

---

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
1. ‚úÖ UnboundLocalError (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
2. üî¥ –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (–ø—Ä–æ–±–ª–µ–º–∞ #1)
3. üî¥ –î–æ–±–∞–≤–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö (–ø—Ä–æ–±–ª–µ–º–∞ #2)
4. üî¥ –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –∫—É–ª–¥–∞—É–Ω–∞ (–ø—Ä–æ–±–ª–µ–º–∞ #4)

### –í–∞–∂–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):
5. üü° –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ billing_loop (–ø—Ä–æ–±–ª–µ–º–∞ #7)
6. üü° –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º (–ø—Ä–æ–±–ª–µ–º–∞ #6)
7. üü° –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–ø—É—Å–∫–∞ —Å–ø–∏—Å–∞–Ω–∏–π (–ø—Ä–æ–±–ª–µ–º–∞ #9)

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (—É–ª—É—á—à–µ–Ω–∏—è):
8. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É canceled –ø–æ–¥–ø–∏—Å–æ–∫ (–ø—Ä–æ–±–ª–µ–º–∞ #8)
9. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ canceled –ø–æ–¥–ø–∏—Å–∫–∏

