# –ê–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è –±–∏–ª–ª–∏–Ω–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-01-27  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** QA Team Lead Analysis

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è](#–æ–±–∑–æ—Ä-—Ç–µ—Å—Ç–æ–≤–æ–≥–æ-–ø–æ–∫—Ä—ã—Ç–∏—è)
2. [–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤](#–¥–µ—Ç–∞–ª—å–Ω–æ–µ-–æ–ø–∏—Å–∞–Ω–∏–µ-—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö-—Ç–µ—Å—Ç–æ–≤)
3. [–ù–µ–ø–æ–∫—Ä—ã—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –ø—Ä–æ–±–µ–ª—ã](#–Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏-–∏-–ø—Ä–æ–±–µ–ª—ã)
4. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏-–¥–ª—è-–¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
5. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)

---

## –û–±–∑–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 29
- **–ü—Ä–æ—Ö–æ–¥—è—â–∏—Ö:** 29 ‚úÖ
- **–ü–æ–∫—Ä—ã—Ç–∏–µ –º–æ–¥—É–ª–µ–π:**
  - `bot/utils/billing_db.py` - —á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–∫—Ä—ã—Ç
  - `bot/handlers/payment_handler.py` - —á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–∫—Ä—ã—Ç
  - `bot/utils/notification.py` - —á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–∫—Ä—ã—Ç
  - `bot/run.py` (billing_loop) - **–ù–ï –ø–æ–∫—Ä—ã—Ç**

### –§–∞–π–ª—ã —Å —Ç–µ—Å—Ç–∞–º–∏

1. `test_billing_loop.py` - 10 —Ç–µ—Å—Ç–æ–≤
2. `test_subscription_mark_charged.py` - 4 —Ç–µ—Å—Ç–∞
3. `test_payment_webhook.py` - 7 —Ç–µ—Å—Ç–æ–≤
4. `test_duplicate_checks.py` - 3 —Ç–µ—Å—Ç–∞
5. `test_cooldown_check.py` - 3 —Ç–µ—Å—Ç–∞
6. `test_notification_idempotency.py` - 3 —Ç–µ—Å—Ç–∞
7. `test_pre_renew_notification.py` - 3 —Ç–µ—Å—Ç–∞

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### 1. –¢–µ—Å—Ç—ã billing loop –∏ –∑–∞—â–∏—Ç—ã –æ—Ç —á–∞—Å—Ç—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π

#### 1.1. `test_precharge_guard_and_attempt_success`
**–ö–µ–π—Å:** –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –§—É–Ω–∫—Ü–∏—è `precharge_guard_and_attempt` —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ø—ã—Ç–∫—É —Å–ø–∏—Å–∞–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `attempt_id`
- –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `_repo.precharge_guard_and_attempt` —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º `attempt_id=123`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `123`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –º–µ—Ç–æ–¥ –≤—ã–∑–≤–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 1.2. `test_precharge_guard_and_attempt_blocked_by_12h_gap`
**–ö–µ–π—Å:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ø—ã—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è –∏–∑-–∑–∞ 12-—á–∞—Å–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Guard –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É, –µ—Å–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω–µ–µ 12 —á–∞—Å–æ–≤
- `last_attempt_at` –±—ã–ª 2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_attempt_at = now - 2 hours`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `precharge_guard_and_attempt`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `attempt_id is None`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 1.3. `test_precharge_guard_and_attempt_blocked_by_6_failures`
**–ö–µ–π—Å:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ 6 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –Ω–µ—É–¥–∞—á–∞—Ö

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Guard –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É, –µ—Å–ª–∏ `consecutive_failures >= 6`
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `consecutive_failures = 6`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `precharge_guard_and_attempt`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `attempt_id is None`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 1.4. `test_precharge_guard_and_attempt_blocked_by_2_attempts_24h`
**–ö–µ–π—Å:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ 2 –ø–æ–ø—ã—Ç–∫–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Guard –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É, –µ—Å–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –±—ã–ª–æ 2 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–ø—ã—Ç–æ–∫
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `consecutive_failures = 0`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 2 –ø–æ–ø—ã—Ç–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `precharge_guard_and_attempt`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `attempt_id is None`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 1.5. `test_subscriptions_due_filters_correctly`
**–ö–µ–π—Å:** –ë–∞–∑–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –§—É–Ω–∫—Ü–∏—è `subscriptions_due` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `_repo.subscriptions_due` —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å–ø–∏—Å–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscriptions_due(now=mock_time, limit=100)`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø—É—Å—Ç–æ–π –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç (–Ω–æ –º–æ–∫–∏—Ä—É–µ—Ç –Ω–∞–ø—Ä—è–º—É—é, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É)

---

#### 1.6. `test_subscriptions_due_filters_by_guard_rules`
**–ö–µ–π—Å:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∑–∞—â–∏—Ç—ã –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü–æ–¥–ø–∏—Å–∫–∏ —Å `consecutive_failures >= 6` –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö guard –ø—Ä–∞–≤–∏–ª

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `consecutive_failures = 6`
- –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscriptions_due`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∞ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 1.7. `test_subscriptions_due_excludes_paid_period` ‚≠ê –ù–û–í–´–ô
**–ö–µ–π—Å:** –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º –∏–∑ –≤—ã–±–æ—Ä–∫–∏

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü–æ–¥–ø–∏—Å–∫–∏ —Å `next_charge_at > now` (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥) –ù–ï –ø–æ–ø–∞–¥–∞—é—Ç –≤ `subscriptions_due`
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π –¥–ª—è —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `next_charge_at = now + 30 days` (–ø–µ—Ä–∏–æ–¥ –æ–ø–ª–∞—á–µ–Ω)
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (—Ñ–∏–ª—å—Ç—Ä `next_charge_at <= now_utc`)
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscriptions_due`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç (–¥–æ–±–∞–≤–ª–µ–Ω)

---

#### 1.8. `test_subscriptions_due_excludes_after_successful_charge` ‚≠ê –ù–û–í–´–ô
**–ö–µ–π—Å:** –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ä–æ–∫–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è `next_charge_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤—ã–±–æ—Ä–∫—É –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:** —Ç—Ä–∏–∞–ª ‚Üí —Å–ø–∏—Å–∞–Ω–∏–µ 2500—Ä ‚Üí —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è:
  - `last_attempt_at = now - 12 hours` (—Å–ø–∏—Å–∞–Ω–∏–µ –±—ã–ª–æ 12 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)
  - `next_charge_at = now + 30 days` (–æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è)
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscriptions_due`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç (–¥–æ–±–∞–≤–ª–µ–Ω)

---

#### 1.9. `test_subscriptions_due_only_includes_due_subscriptions` ‚≠ê –ù–û–í–´–ô
**–ö–µ–π—Å:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∞—Ö —É –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∞—Ö –≤ –≤—ã–±–æ—Ä–∫—É –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö `next_charge_at <= now`
- –ü–æ–¥–ø–∏—Å–∫–∏ —Å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º (`next_charge_at > now`) –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –¥–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏:
  - –ü–æ–¥–ø–∏—Å–∫–∞ 1: `next_charge_at = now - 1 day` (—Å—Ä–æ–∫ –Ω–∞—Å—Ç—É–ø–∏–ª) - –¥–æ–ª–∂–Ω–∞ –ø–æ–ø–∞—Å—Ç—å
  - –ü–æ–¥–ø–∏—Å–∫–∞ 2: `next_charge_at = now + 60 days` (–ø–µ—Ä–∏–æ–¥ –æ–ø–ª–∞—á–µ–Ω) - –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–æ–ø–∞—Å—Ç—å
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫—É 1
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscriptions_due`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞ 1

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç (–¥–æ–±–∞–≤–ª–µ–Ω)

---

#### 1.10. `test_subscriptions_due_no_repeat_charge_within_12h` ‚≠ê –ù–û–í–´–ô
**–ö–µ–π—Å:** –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 12 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ —Å—Ä–æ–∫–æ–º –Ω–∞—Å—Ç—É–ø–∏–≤—à–∏–º (`next_charge_at <= now`)
- –ù–æ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è 6 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
- –ü–æ–¥–ø–∏—Å–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ–º 12h gap
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞:
  - `next_charge_at = now - 1 day` (—Å—Ä–æ–∫ –Ω–∞—Å—Ç—É–ø–∏–ª)
  - –í –±–∞–∑–µ –µ—Å—Ç—å –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è 6 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 12h –æ–∫–Ω–∞)
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å `blocked_ids_gap12h`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `subscription_id=1`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `subscriptions_due`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç (–¥–æ–±–∞–≤–ª–µ–Ω)

---

### 2. –¢–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

#### 2.1. `test_subscription_mark_charged_by_subscription_id`
**–ö–µ–π—Å:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ `subscription_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –§—É–Ω–∫—Ü–∏—è `subscription_mark_charged_for_user` –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ `subscription_id`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ `user_id` (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è: `last_charge_at`, `next_charge_at`, `consecutive_failures = 0`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `flush()`

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `_repo._session_factory`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `user_id` –∏ —Å—Ç–∞—Ç—É—Å–æ–º `active`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `s.get()` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Å `subscription_id=1`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `subscription_id`, `consecutive_failures` —Å–±—Ä–æ—à–µ–Ω, `flush` –≤—ã–∑–≤–∞–Ω

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 2.2. `test_subscription_mark_charged_by_plan_code`
**–ö–µ–π—Å:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ `plan_code`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –§—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ `plan_code` –∏ `user_id`
- –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- Fallback –ª–æ–≥–∏–∫–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ `plan_code`

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `_repo._session_factory`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `plan_code="1m"`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `query().filter().first()` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Å `plan_code="1m"`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `subscription_id`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 2.3. `test_subscription_mark_charged_subscription_not_found`
**–ö–µ–π—Å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `_repo._session_factory`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `s.get()` –∏ `query()` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ `None`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º `subscription_id=999`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç `None`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 2.4. `test_subscription_mark_charged_inactive_subscription_fallback`
**–ö–µ–π—Å:** Fallback –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ –ø–æ `subscription_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ï—Å–ª–∏ `subscription_id` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (`status="canceled"`)
- –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fallback –ø–æ–∏—Å–∫ –ø–æ `plan_code`
- –ù–∞—Ö–æ–¥–∏—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `_repo._session_factory`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (`status="canceled"`) –ø–æ `subscription_id=1`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (`status="active"`) –ø–æ `plan_code="1m"`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è fallback –ø–æ–∏—Å–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Å `subscription_id=1` –∏ `plan_code="1m"`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `id` –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

### 3. –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook –æ—Ç YooKassa

#### 3.1. `test_webhook_succeeded_trial_payment`
**–ö–µ–π—Å:** –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∏–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Webhook `payment.succeeded` —Å `phase="trial"` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `subscription_upsert`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –ü–ª–∞—Ç–µ–∂ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (billing_db, app_db, yookassa_dedup, notify)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è `should_process = True`, `payment_log_is_processed = False`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook` —Å —Ç—Ä–∏–∞–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 200, –≤—ã–∑–æ–≤ `subscription_upsert`, –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 3.2. `test_webhook_succeeded_renewal_payment`
**–ö–µ–π—Å:** –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Webhook `payment.succeeded` —Å `phase="renewal"` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `subscription_mark_charged_for_user`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –ü–ª–∞—Ç–µ–∂ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è `subscription_mark_charged_for_user` –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–º `subscription_id=2`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook` —Å –ø–ª–∞—Ç–µ–∂–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 200, –≤—ã–∑–æ–≤ `subscription_mark_charged_for_user`, –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 3.3. `test_webhook_canceled_payment`
**–ö–µ–π—Å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Webhook `payment.canceled` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –ø–æ–ø—ã—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ `mark_charge_attempt_status`
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `consecutive_failures` –ø–æ–¥–ø–∏—Å–∫–∏

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `consecutive_failures`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook` —Å –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 200, –≤—ã–∑–æ–≤ `mark_charge_attempt_status`, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "fail"

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 3.4. `test_webhook_duplicate_processing`
**–ö–µ–π—Å:** –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞ webhook

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –î—É–±–ª–∏–∫–∞—Ç–Ω—ã–µ webhook –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `yookassa_dedup.should_process` –∏ `payment_log_is_processed`

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è `should_process = False` –∏ `payment_log_is_processed = True`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 200, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "duplicate" –∏–ª–∏ "no-op"

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 3.5. `test_webhook_missing_payment_id`
**–ö–µ–π—Å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –±–µ–∑ `payment_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Webhook –±–µ–∑ `payment_id` –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 400

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è payload –±–µ–∑ `payment_id`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 400, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "payment_id"

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 3.6. `test_webhook_renewal_subscription_not_found`
**–ö–µ–π—Å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü–ª–∞—Ç–µ–∂ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è `subscription_mark_charged_for_user` –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–º `None`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π `None`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook` —Å –ø–ª–∞—Ç–µ–∂–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 200, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 3.7. `test_webhook_waiting_for_capture`
**–ö–µ–π—Å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `waiting_for_capture`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- Webhook `payment.waiting_for_capture` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü–ª–∞—Ç–µ–∂ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `payment_log_upsert`

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è payload —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `waiting_for_capture`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `process_yookassa_webhook`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å 200, –≤—ã–∑–æ–≤ `payment_log_upsert`, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "waiting_for_capture"

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

### 4. –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

#### 4.1. `test_duplicate_check_with_payment_id`
**–ö–µ–π—Å:** –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞ –ø–æ `payment_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å `payment_id`, –æ–Ω–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å `payment_id = "test_payment_123"`
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç —ç—Ç—É –ø–æ–ø—ã—Ç–∫—É
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 4.2. `test_duplicate_check_recent_attempt_without_payment_id`
**–ö–µ–π—Å:** –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–µ–¥–∞–≤–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏ –±–µ–∑ `payment_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ–¥–∞–≤–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `payment_id` (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5 –º–∏–Ω—É—Ç), –æ–Ω–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –ø—Ä–∏ race condition

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `payment_id`, —Å–æ–∑–¥–∞–Ω–Ω–∞—è 2 –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥
- –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞: –ø–µ—Ä–≤—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`, –≤—Ç–æ—Ä–æ–π - –Ω–µ–¥–∞–≤–Ω—é—é –ø–æ–ø—ã—Ç–∫—É
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –Ω–µ–¥–∞–≤–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 4.3. `test_duplicate_check_old_attempt_without_payment_id`
**–ö–µ–π—Å:** –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏ –±–µ–∑ `payment_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –°—Ç–∞—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `payment_id` (–≤–Ω–µ –æ–∫–Ω–∞ 5 –º–∏–Ω—É—Ç) –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ–∫–Ω–∞

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `payment_id`, —Å–æ–∑–¥–∞–Ω–Ω–∞—è 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
- –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `None` (–≤–Ω–µ –æ–∫–Ω–∞ 5 –º–∏–Ω—É—Ç)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Å—Ç–∞—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

### 5. –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ cooldown –∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ç—Ä–∏–∞–ª

#### 5.1. `test_cooldown_with_canceled_subscription`
**–ö–µ–π—Å:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∏–∞–ª–∞ –ø—Ä–∏ –Ω–µ–¥–∞–≤–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at` –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 90 –¥–Ω–µ–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –≤–º–µ—Å—Ç–æ —Ç—Ä–∏–∞–ª–∞

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at = now - 30 days` (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 90 –¥–Ω–µ–π)
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `_create_links_for_selection`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (–Ω–µ —Ç—Ä–∏–∞–ª)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 5.2. `test_cooldown_with_old_canceled_subscription`
**–ö–µ–π—Å:** –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ –ø—Ä–∏ —Å—Ç–∞—Ä–æ–π –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at` –±–æ–ª–µ–µ 90 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ç—Ä–∏–∞–ª
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `is_trial_allowed`

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at = now - 100 days` (–±–æ–ª–µ–µ 90 –¥–Ω–µ–π)
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `is_trial_allowed` –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–º `True`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `_create_links_for_selection`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —Ç—Ä–∏–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 5.3. `test_cooldown_with_active_subscription`
**–ö–µ–π—Å:** –ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (–Ω–µ —Ç—Ä–∏–∞–ª)
- `has_active_subscription = True` ‚Üí `phase = "renewal"`

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `_create_links_for_selection`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

### 6. –¢–µ—Å—Ç—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### 6.1. `test_notify_after_payment_idempotency`
**–ö–µ–π—Å:** –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –æ–¥–Ω–æ–≥–æ `payment_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ —Å `payment_id` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ —Å —Ç–µ–º –∂–µ `payment_id` –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Redis –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: –º–æ–∫–∏—Ä—É–µ—Ç—Å—è `set_nx_with_ttl` –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–º `True` (–∫–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `send_message` –≤—ã–∑–≤–∞–Ω
- –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ —Å —Ç–µ–º –∂–µ `payment_id`: –º–æ–∫–∏—Ä—É–µ—Ç—Å—è `set_nx_with_ttl` –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–º `False` (–∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `send_message` –ù–ï –≤—ã–∑–≤–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 6.2. `test_notify_after_payment_without_payment_id`
**–ö–µ–π—Å:** –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–µ–∑ `payment_id`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–∞–∂–µ –±–µ–∑ `payment_id`
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–Ω–µ—Ç –∫–ª—é—á–∞ Redis)

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Å `payment_id=None`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 6.3. `test_notify_after_payment_redis_error`
**–ö–µ–π—Å:** –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ Redis

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –ü—Ä–∏ –æ—à–∏–±–∫–µ Redis —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (fallback)
- –û—à–∏–±–∫–∞ Redis –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ú–æ–∫–∏—Ä—É–µ—Ç—Å—è `set_nx_with_ttl` –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—â–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è —Å `payment_id`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

### 7. –¢–µ—Å—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º

#### 7.1. `test_pre_renew_notification_skipped_recent_charge`
**–ö–µ–π—Å:** –ü—Ä–æ–ø—É—Å–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–∞–≤–Ω–µ–º —Å–ø–∏—Å–∞–Ω–∏–∏

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –µ—Å–ª–∏ `last_charge_at < 2 hours`
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at = now - 1 hour`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `run_paid_lifecycle`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 7.2. `test_pre_renew_notification_sent_old_charge`
**–ö–µ–π—Å:** –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ `last_charge_at > 2 hours`
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ `next_charge_at` –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 24 —á–∞—Å–æ–≤

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at = now - 3 hours`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `run_paid_lifecycle`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

#### 7.3. `test_pre_renew_notification_no_last_charge_at`
**–ö–µ–π—Å:** –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `last_charge_at`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ `last_charge_at = None`
- Fallback –ª–æ–≥–∏–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫

**–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at = None`
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `run_paid_lifecycle`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (–µ—Å–ª–∏ `next_charge_at` –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 24 —á–∞—Å–æ–≤)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–∫—Ä—ã—Ç

---

## –ù–µ–ø–æ–∫—Ä—ã—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –ø—Ä–æ–±–µ–ª—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã

#### 1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã billing_loop**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `billing_loop()` –∏–∑ `bot/run.py`

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –≤ `billing_loop()`
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ `youmoney.charge_saved_method()`
- –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –ø–æ–ø—ã—Ç–∫–æ–π —á–µ—Ä–µ–∑ `link_payment_to_attempt()`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ (`mark_charge_attempt_status`)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–∏–ª–ª–∏–Ω–≥–∞

---

#### 2. **–¢–µ—Å—Ç—ã subscription_upsert**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `subscription_upsert()`

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (SELECT FOR UPDATE)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `payment_method_id` –ø—Ä–∏ `update_payment_method=False`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `payment_method_id` –ø—Ä–∏ `update_payment_method=True`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ canceled –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ active

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

---

#### 3. **–¢–µ—Å—Ç—ã subscription_cancel_for_user**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `subscription_cancel_for_user()`

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –û—Ç–º–µ–Ω–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π: `status="canceled"`, `cancel_at`, `payment_method_id=None`, `next_charge_at=None`
- –û—Ç–º–µ–Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 4. **–¢–µ—Å—Ç—ã record_charge_attempt –∏ mark_charge_attempt_status**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Å–ø–∏—Å–∞–Ω–∏—è

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ø—ã—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ `record_charge_attempt()`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ø—ã—Ç–∫–∏ —á–µ—Ä–µ–∑ `mark_charge_attempt_status()`
- –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –ø–æ–ø—ã—Ç–∫–æ–π —á–µ—Ä–µ–∑ `link_payment_to_attempt()`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `consecutive_failures` –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_fail_notice_at` –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 5. **–¢–µ—Å—Ç—ã card_upsert_from_provider**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ä—Ç—ã
- –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 6. **–¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ billing_loop**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `ValueError` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ "failed" –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 7. **–¢–µ—Å—Ç—ã edge cases –¥–ª—è subscription_mark_charged_for_user**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å `subscription_id` –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ø—Ä–æ–≤–µ—Ä–∫–∞ `user_id`)
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –Ω–æ –Ω–µ—Ç `plan_code` –¥–ª—è fallback
- Fallback –ø–æ–∏—Å–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ª—é–±–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ `user_id` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 8. **–¢–µ—Å—Ç—ã –¥–ª—è subscriptions_due - edge cases**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å `next_charge_at = None` (–Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–æ–ø–∞—Å—Ç—å)
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å `payment_method_id = None` (–Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–æ–ø–∞—Å—Ç—å)
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å `status != "active"` (–Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–æ–ø–∞—Å—Ç—å)
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å 6 –Ω–µ—É—Å–ø–µ—à–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ —Ç–µ–∫—É—â–µ–º —Ü–∏–∫–ª–µ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å `last_attempt_at` –º–µ–Ω–µ–µ 12 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏)
- –õ–∏–º–∏—Ç `limit` –≤ `subscriptions_due` (–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 9. **–¢–µ—Å—Ç—ã –¥–ª—è precharge_guard_and_attempt - edge cases**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (`rec is None`)
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (`status != "active"`)
- –ü–æ–¥–ø–∏—Å–∫–∞ –±–µ–∑ `payment_method_id` (`payment_method_id is None`)
- `consecutive_failures = 5` (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏)
- `last_attempt_at = None` (–¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏)
- `last_attempt_at` —Ä–æ–≤–Ω–æ 12 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥ (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- 1 –ø–æ–ø—ã—Ç–∫–∞ –∑–∞ 24 —á–∞—Å–∞ (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏)
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ `ChargeAttempt` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 10. **–¢–µ—Å—Ç—ã –¥–ª—è webhook - edge cases**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- Webhook —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö
- Webhook —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (–∫—Ä–æ–º–µ `payment_id`)
- Webhook —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º `user_id` –≤ metadata
- Webhook —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º `plan_code` –≤ metadata
- Webhook —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º `created_at` (–ø–∞—Ä—Å–∏–Ω–≥ –æ—à–∏–±–∫–∏)
- Webhook —Å `pm_token = None` –¥–ª—è renewal (–¥–æ–ª–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
- Webhook —Å `pm_token = None` –¥–ª—è trial (–¥–æ–ª–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ `membership_invite`

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 11. **–¢–µ—Å—Ç—ã –¥–ª—è duplicate checks - edge cases**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü–æ–ø—ã—Ç–∫–∞ —Å `payment_id` –∏ —Å—Ç–∞—Ç—É—Å–æ–º –Ω–µ "created" (–Ω–µ –¥–æ–ª–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)
- –ü–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `payment_id` —Ä–æ–≤–Ω–æ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- –ü–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `payment_id` —Ä–æ–≤–Ω–æ 5 –º–∏–Ω—É—Ç –∏ 1 —Å–µ–∫—É–Ω–¥—É –Ω–∞–∑–∞–¥ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
- –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –±–µ–∑ `payment_id` –≤ –æ–∫–Ω–µ 5 –º–∏–Ω—É—Ç

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

---

#### 12. **–¢–µ—Å—Ç—ã –¥–ª—è cooldown - edge cases**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at` —Ä–æ–≤–Ω–æ 90 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å `last_charge_at = None`
- –ù–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (–¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è)
- `is_trial_allowed` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False` –ø—Ä–∏ —Å—Ç–∞—Ä–æ–π –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

---

#### 13. **–¢–µ—Å—Ç—ã –¥–ª—è notification - edge cases**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- `next_charge_at` —Ä–æ–≤–Ω–æ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- `next_charge_at` –±–æ–ª–µ–µ —á–µ–º —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è)
- `last_charge_at` —Ä–æ–≤–Ω–æ 2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥ (–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ —É –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

---

### üü° –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã

#### 14. **–¢–µ—Å—Ç—ã –¥–ª—è payment_log —Ñ—É–Ω–∫—Ü–∏–π**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –ª–æ–≥–∞–º–∏ –ø–ª–∞—Ç–µ–∂–µ–π

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- `payment_log_upsert()` - —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ –ø–ª–∞—Ç–µ–∂–∞
- `payment_log_is_processed()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
- `payment_log_mark_processed()` - –ø–æ–º–µ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

---

#### 15. **–¢–µ—Å—Ç—ã –¥–ª—è list_active_subscription_user_ids**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `next_charge_at > now` (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥)
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ `user_id` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å)

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

---

#### 16. **–¢–µ—Å—Ç—ã –¥–ª—è delete_user_card_and_detach_subscriptions**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã

**–ß—Ç–æ –Ω–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –æ—Ç –ø–æ–¥–ø–∏—Å–æ–∫ (`payment_method_id = None`)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

### üî¥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)

#### 1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç billing_loop**
```python
def test_billing_loop_full_cycle():
    """
    –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ billing_loop:
    1. subscriptions_due –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥–∏—Ç
    3. precharge_guard_and_attempt —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ø—ã—Ç–∫—É
    4. youmoney.charge_saved_method —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
    5. link_payment_to_attempt —Å–≤—è–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —Å –ø–æ–ø—ã—Ç–∫–æ–π
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–∏–ª–ª–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏

---

#### 2. **–¢–µ—Å—Ç subscription_upsert - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏**
```python
def test_subscription_upsert_creates_new():
    """
    –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:
    1. –ü–æ–¥–ø–∏—Å–∫–∏ —Å —Ç–∞–∫–∏–º plan_code –Ω–µ—Ç
    2. –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
    3. –í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

---

#### 3. **–¢–µ—Å—Ç subscription_upsert - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏**
```python
def test_subscription_upsert_updates_existing():
    """
    –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏:
    1. –ü–æ–¥–ø–∏—Å–∫–∞ —Å —Ç–∞–∫–∏–º plan_code —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    2. –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è
    3. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç (SELECT FOR UPDATE)
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

---

#### 4. **–¢–µ—Å—Ç subscription_upsert - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π**
```python
def test_subscription_upsert_prevents_duplicates():
    """
    –¢–µ—Å—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–µ–π:
    1. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã subscription_upsert —Å –æ–¥–Ω–∏–º plan_code
    2. SELECT FOR UPDATE –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–µ–π
    3. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ó–∞—â–∏—Ç–∞ –æ—Ç race condition –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫

---

#### 5. **–¢–µ—Å—Ç subscription_mark_charged_for_user - –ø—Ä–æ–≤–µ—Ä–∫–∞ user_id**
```python
def test_subscription_mark_charged_wrong_user_id():
    """
    –¢–µ—Å—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ user_id:
    1. subscription_id –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    2. –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None
    3. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á—É–∂–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

---

#### 6. **–¢–µ—Å—Ç subscriptions_due - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ next_charge_at = None**
```python
def test_subscriptions_due_excludes_none_next_charge_at():
    """
    –¢–µ—Å—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ —Å next_charge_at = None:
    1. –ü–æ–¥–ø–∏—Å–∫–∞ —Å next_charge_at = None
    2. –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤—ã–±–æ—Ä–∫—É
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –±–µ–∑ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã

---

#### 7. **–¢–µ—Å—Ç subscriptions_due - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ payment_method_id = None**
```python
def test_subscriptions_due_excludes_no_payment_method():
    """
    –¢–µ—Å—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –±–µ–∑ payment_method_id:
    1. –ü–æ–¥–ø–∏—Å–∫–∞ —Å payment_method_id = None
    2. –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤—ã–±–æ—Ä–∫—É
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã

---

#### 8. **–¢–µ—Å—Ç subscriptions_due - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ 6 –Ω–µ—É—Å–ø–µ—à–Ω—ã–º –ø–æ–ø—ã—Ç–∫–∞–º –≤ —Ü–∏–∫–ª–µ**
```python
def test_subscriptions_due_excludes_6_failed_in_cycle():
    """
    –¢–µ—Å—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ —Å 6 –Ω–µ—É—Å–ø–µ—à–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ —Ç–µ–∫—É—â–µ–º —Ü–∏–∫–ª–µ:
    1. –ü–æ–¥–ø–∏—Å–∫–∞ —Å next_charge_at = X
    2. 6 –ø–æ–ø—ã—Ç–æ–∫ —Å due_at = X –∏ status IN ('canceled', 'expired')
    3. –ù–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤—ã–±–æ—Ä–∫—É
    """
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:** –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ä–µ—Ç—Ä–∞–µ–≤

---

### üü° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ)

#### 9. **–¢–µ—Å—Ç subscription_cancel_for_user**
```python
def test_subscription_cancel_for_user():
    """
    –¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ã –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    1. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
    2. –í—Å–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è
    3. –ü–æ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è: status="canceled", cancel_at, payment_method_id=None, next_charge_at=None
    """
```

---

#### 10. **–¢–µ—Å—Ç record_charge_attempt**
```python
def test_record_charge_attempt():
    """
    –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–æ–ø—ã—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏—è:
    1. –°–æ–∑–¥–∞–µ—Ç—Å—è ChargeAttempt —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    2. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è last_attempt_at –ø–æ–¥–ø–∏—Å–∫–∏
    3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è attempt_id
    """
```

---

#### 11. **–¢–µ—Å—Ç mark_charge_attempt_status**
```python
def test_mark_charge_attempt_status():
    """
    –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ø—ã—Ç–∫–∏:
    1. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –ø–æ–ø—ã—Ç–∫–∏
    2. –ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è consecutive_failures
    3. –ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è last_fail_notice_at
    """
```

---

#### 12. **–¢–µ—Å—Ç link_payment_to_attempt**
```python
def test_link_payment_to_attempt():
    """
    –¢–µ—Å—Ç —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —Å –ø–æ–ø—ã—Ç–∫–æ–π:
    1. payment_id —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å attempt_id
    2. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å ChargeAttempt
    """
```

---

#### 13. **–¢–µ—Å—Ç billing_loop - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
```python
def test_billing_loop_handles_errors():
    """
    –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ billing_loop:
    1. ValueError –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
    2. –°—Ç–∞—Ç—É—Å –ø–æ–ø—ã—Ç–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ "failed"
    3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
    """
```

---

#### 14. **–¢–µ—Å—Ç webhook - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
```python
def test_webhook_handles_errors():
    """
    –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ webhook:
    1. –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã (–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É)
    2. –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É)
    3. –û—à–∏–±–∫–∞ –ø—Ä–∏ membership_invite (–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É)
    """
```

---

### üü¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

#### 15. **–¢–µ—Å—Ç—ã –¥–ª—è edge cases –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π**
- –ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ (—Ä–æ–≤–Ω–æ 12 —á–∞—Å–æ–≤, —Ä–æ–≤–Ω–æ 24 —á–∞—Å–∞, —Ä–æ–≤–Ω–æ 90 –¥–Ω–µ–π)
- –ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ (5 –Ω–µ—É–¥–∞—á, 6 –Ω–µ—É–¥–∞—á)
- None –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –ø–æ–ª–µ–π
- –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 1. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è billing_loop**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

### 2. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è subscription_upsert**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –ø–æ–∫—Ä—ã—Ç–∞ —Ç–µ—Å—Ç–∞–º–∏
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∑–∞—â–∏—Ç—É –æ—Ç –¥—É–±–ª–µ–π

### 3. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è subscription_cancel_for_user**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É –ø–æ–¥–ø–∏—Å–æ–∫
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π

### 4. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ø—ã—Ç–∫–∞–º–∏**
- `record_charge_attempt`
- `mark_charge_attempt_status`
- `link_payment_to_attempt`

### 5. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è edge cases**
- –ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- None –∑–Ω–∞—á–µ–Ω–∏—è
- –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 6. **–£–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã**
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –º–æ–∫–∏—Ä—É—é—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `test_subscriptions_due_filters_correctly`)
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É SQL-–∑–∞–ø—Ä–æ—Å–æ–≤

### 7. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ–¥–ø–∏—Å–æ–∫ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ø—ã—Ç–æ–∫

### 8. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è race conditions**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å SELECT FOR UPDATE

---

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è

### –ü–æ–∫—Ä—ã—Ç–æ ‚úÖ
- **–ë–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:** 85%
- **–ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π:** 90%
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook:** 80%
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:** 100%
- **Cooldown –∏ —Ç—Ä–∏–∞–ª:** 100%
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** 100%
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º:** 100%

### –ù–µ –ø–æ–∫—Ä—ã—Ç–æ ‚ùå
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã billing_loop:** 0%
- **subscription_upsert:** 0%
- **subscription_cancel_for_user:** 0%
- **–§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ø—ã—Ç–∫–∞–º–∏:** 0%
- **–§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–∞–º–∏:** 0%
- **Edge cases:** 30%

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è: **~65%**

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–µ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ö–æ—Ä–æ—à—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –Ω–æ –∏–º–µ–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö –∏ —Ç–µ—Å—Ç–∞—Ö –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (`subscription_upsert`, `billing_loop`). 

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å:**
1. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è `billing_loop`
2. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `subscription_upsert`
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `subscription_cancel_for_user`
4. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Å–ø–∏—Å–∞–Ω–∏—è

–≠—Ç–æ –ø–æ–≤—ã—Å–∏—Ç –æ–±—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –¥–æ ~85% –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –Ω–∞–¥–µ–∂–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

